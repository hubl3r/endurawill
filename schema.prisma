// Endurawill - Production-Ready Database Schema
// Built for scale, audit trails, and granular permissions
// Version: 2.2 - Added POA Power Limitations and Limited POA Templates
// APPENDED: POAPowerLimitation and LimitedPOATemplate models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

// Account Management Enums
enum PaymentFrequency {
  NONE
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
  ONE_TIME
  OTHER
}

enum PaymentStatus {
  UPCOMING
  PAID
  PAST_DUE
  PARTIAL
  SKIPPED
}

enum CalculationMode {
  AUTOMATIC
  MANUAL
}

// ============================================
// TENANT = An Estate (Individual or Joint)
// ============================================
model Tenant {
  id          String   @id @default(uuid())
  name        String?
  type        String   @default("individual")
  
  maxOwners   Int      @default(1)
  ownerCount  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users              User[]
  documents          Document[]
  assets             Asset[]
  liabilities        Liability[]
  beneficiaries      Beneficiary[]
  directives         Directive[]
  finalArrangements  FinalArrangement[]
  delegates          Delegate[]
  settings           TenantSettings?
  auditLogs          AuditLog[]
  accounts           Account[]
  paymentHistory     PaymentHistory[]
  accountAttachments AccountAttachment[]
  
  // POA Relations
  powerOfAttorneys   PowerOfAttorney[] @relation("PowerOfAttorneys")
  healthcarePOAs     HealthcarePOA[] @relation("HealthcarePOAs")
  poaRevocations     POARevocation[] @relation("POARevocations")
  
  // Wizard Relations
  wizardProgress     WizardProgress[]
  
  @@index([type])
}

// ============================================
// USER = A person with access to the estate
// ============================================
model User {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clerkId    String
  
  role       String
  isPrimary  Boolean  @default(false)
  
  fullName   String
  email      String?
  dob        DateTime?
  phone      String?
  
  profile    Profile?
  
  twoFactorEnabled Boolean @default(false)
  
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sessions              Session[]
  auditLogs             AuditLog[]
  createdDocuments      Document[] @relation("CreatedBy")
  modifiedDocuments     Document[] @relation("ModifiedBy")
  comments              Comment[]
  resourcePermissions   ResourcePermission[]
  delegateRecord        Delegate? @relation("DelegateUser")
  invitedDelegates      Delegate[] @relation("InvitedBy")
  createdAccounts       Account[] @relation("AccountCreatedBy")
  modifiedAccounts      Account[] @relation("AccountModifiedBy")
  uploadedAttachments   AccountAttachment[]
  
  // POA Relations
  principalPOAs         PowerOfAttorney[] @relation("PrincipalPOAs")
  agentPOAs             POAAgent[] @relation("UserPOAAgents")
  createdPOAs           PowerOfAttorney[] @relation("CreatedPOAs")
  revokedPOAs           POARevocation[] @relation("UserPOARevocations")
  poaAuditLogs          POAAuditLog[] @relation("UserPOAAuditLogs")
  principalHealthcarePOAs HealthcarePOA[] @relation("PrincipalHealthcarePOAs")
  createdHealthcarePOAs HealthcarePOA[] @relation("CreatedHealthcarePOAs")
  healthcarePOAAuditLogs HealthcarePOAAuditLog[] @relation("UserHealthcarePOAAuditLogs")
  uploadedStatutoryForms StatutoryPOAForm[] @relation("UploadedStatutoryForms")
  uploadedNotaryTemplates NotaryBlockTemplate[] @relation("UploadedNotaryTemplates")
  
  // Wizard Relations
  wizardProgress        WizardProgress[]
  
  @@unique([tenantId, clerkId])
  @@index([clerkId])
  @@index([tenantId])
  @@index([role])
}

// ============================================
// PROFILE = Extended info for estate owners
// ============================================
model Profile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  stateResidence  String?
  maritalStatus   String?
  
  goals           Json?
  complexityLevel String?
  selectedPlan    String?
  
  hasCompletedOnboarding Boolean @default(false)
  onboardingStep  Int     @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  children        Child[]
  pets            Pet[]
}

// ============================================
// CHILD = Profile's children
// ============================================
model Child {
  id           String   @id @default(uuid())
  profileId    String
  profile      Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  fullName     String
  dob          DateTime?
  relationship String   @default("child")
  isMinor      Boolean  @default(true)
  
  guardianPreference String?
  beneficiaryId String?
  notes        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([profileId])
}

// ============================================
// PET = Profile's pets
// ============================================
model Pet {
  id             String   @id @default(uuid())
  profileId      String
  profile        Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  name           String
  type           String
  breed          String?
  age            Int?
  
  specialNeeds   String?
  vetInfo        Json?
  careInstructions String?
  
  caretakerPreference String?
  trustFund       Boolean @default(false)
  trustAmount     Decimal? @db.Decimal(15, 2)
  
  notes          String?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([profileId])
}

// ============================================
// RESOURCE PERMISSION = Granular access control
// ============================================
model ResourcePermission {
  id           String   @id @default(uuid())
  tenantId     String
  
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  resourceType String
  resourceId   String?
  documentType String?
  
  canView      Boolean  @default(false)
  canEdit      Boolean  @default(false)
  canDelete    Boolean  @default(false)
  canDownload  Boolean  @default(false)
  canShare     Boolean  @default(false)
  canModifyPermissions Boolean @default(false)
  
  grantedBy    String
  grantedAt    DateTime @default(now())
  revokedBy    String?
  revokedAt    DateTime?
  isActive     Boolean  @default(true)
  
  reason       String?
  notes        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([userId, resourceType, resourceId, documentType])
  @@index([userId])
  @@index([tenantId])
  @@index([resourceType, resourceId])
  @@index([isActive])
  @@index([documentType])
}

// ============================================
// TENANT SETTINGS = Estate-wide preferences
// ============================================
model TenantSettings {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  requireBothOwnersApproval Boolean @default(false)
  primaryCanOverride        Boolean @default(true)
  
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)
  notifyOnDelegateAccess Boolean @default(true)
  
  require2FA         Boolean @default(false)
  sessionTimeout     Int     @default(30)
  ipWhitelist        Json?
  
  autoVersioning     Boolean @default(true)
  retentionPeriod    Int     @default(50)
  
  allowDelegateInvite Boolean @default(true)
  requireDelegateApproval Boolean @default(true)
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// ============================================
// SESSION = Tracking user sessions
// ============================================
model Session {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token      String   @unique
  ipAddress  String?
  userAgent  String?  @db.Text
  
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

// ============================================
// AUDIT LOG = Immutable activity tracking
// ============================================
model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action      String
  resourceType String
  resourceId  String?
  
  details     Json?
  ipAddress   String?
  userAgent   String?  @db.Text
  
  timestamp   DateTime @default(now())
  
  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([timestamp])
}

// ============================================
// DOCUMENT = Central document management
// ============================================
model Document {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title       String
  description String?  @db.Text
  isFolder    Boolean  @default(false)
  type        String
  
  parentId    String?
  parent      Document? @relation("DocumentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Document[] @relation("DocumentHierarchy")
  
  status      String   @default("draft")
  version     Int      @default(1)
  
  fileUrl     String?
  fileName    String?
  fileType    String?
  fileSize    Int?
  
  content     Json?
  metadata    Json?
  
  tags        String[]
  
  createdById String?
  createdBy   User?    @relation("CreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  
  modifiedById String?
  modifiedBy  User?    @relation("ModifiedBy", fields: [modifiedById], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  comments    Comment[]
  versions    DocumentVersion[]
  
  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([parentId])
  @@index([createdById])
}

// ============================================
// DOCUMENT VERSION = Version history
// ============================================
model DocumentVersion {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  version    Int
  
  fileUrl    String?
  fileName   String?
  content    Json?
  
  changedBy  String
  changeNote String?  @db.Text
  
  createdAt  DateTime @default(now())
  
  @@unique([documentId, version])
  @@index([documentId])
}

// ============================================
// COMMENT = Document collaboration
// ============================================
model Comment {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content    String   @db.Text
  isResolved Boolean  @default(false)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([documentId])
  @@index([userId])
}

// ============================================
// ASSET = Assets in the estate
// ============================================
model Asset {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type        String
  name        String
  description String?  @db.Text
  
  value       Decimal  @db.Decimal(15, 2)
  
  location    String?
  accountNumber String?
  institutionName String?
  
  ownership   String?
  beneficiary String?
  
  metadata    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([type])
}

// ============================================
// LIABILITY = Debts and obligations
// ============================================
model Liability {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type        String
  name        String
  description String?  @db.Text
  
  balance     Decimal  @db.Decimal(15, 2)
  monthlyPayment Decimal? @db.Decimal(10, 2)
  
  creditor    String?
  accountNumber String?
  
  metadata    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([type])
}

// ============================================
// BENEFICIARY = People who inherit
// ============================================
model Beneficiary {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  fullName    String
  relationship String
  
  email       String?
  phone       String?
  address     String?
  
  percentage  Decimal? @db.Decimal(5, 2)
  specificAssets String[] @default([])
  
  isPrimary   Boolean  @default(false)
  isContingent Boolean @default(false)
  
  metadata    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
}

// ============================================
// DIRECTIVE = Advance directives, living wills
// ============================================
model Directive {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type        String
  title       String
  
  content     Json
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([type])
}

// ============================================
// FINAL ARRANGEMENT = Funeral, burial preferences
// ============================================
model FinalArrangement {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type        String
  preferences Json
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
}

// ============================================
// DELEGATE = Trusted advisor access
// ============================================
model Delegate {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId      String   @unique
  user        User     @relation("DelegateUser", fields: [userId], references: [id], onDelete: Cascade)
  
  role        String
  permissions Json
  
  invitedBy   String
  inviter     User     @relation("InvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)
  
  status      String   @default("pending")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([userId])
}

// ============================================
// ACCOUNT MANAGEMENT SYSTEM
// ============================================

model Account {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  accountName       String
  accountType       String
  institutionName   String?
  accountNumber     String?
  
  isPrimaryAccount  Boolean  @default(false)
  isJointAccount    Boolean  @default(false)
  jointOwnerName    String?
  
  currentBalance    Decimal? @db.Decimal(15, 2)
  availableBalance  Decimal? @db.Decimal(15, 2)
  creditLimit       Decimal? @db.Decimal(15, 2)
  interestRate      Decimal? @db.Decimal(5, 4)
  
  minimumPayment    Decimal? @db.Decimal(10, 2)
  statementBalance  Decimal? @db.Decimal(15, 2)
  statementDate     DateTime?
  dueDate           DateTime?
  
  paymentFrequency  PaymentFrequency @default(NONE)
  anticipatedAmount Decimal? @db.Decimal(10, 2)
  autoPayEnabled    Boolean  @default(false)
  autoPayAmount     Decimal? @db.Decimal(10, 2)
  autoPayDay        Int?
  
  includeInNetWorth Boolean  @default(true)
  
  routingNumber     String?
  swiftCode         String?
  ibanNumber        String?
  
  loginUrl          String?
  customerServicePhone String?
  
  notes             String?  @db.Text
  tags              String[] @default([])
  
  lastSyncedAt      DateTime?
  nextPaymentDate   DateTime?
  isActive          Boolean  @default(true)
  closedAt          DateTime?
  
  paymentHistory    PaymentHistory[]
  attachments       AccountAttachment[]
  
  createdById       String?
  createdBy         User?    @relation("AccountCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  
  modifiedById      String?
  modifiedBy        User?    @relation("AccountModifiedBy", fields: [modifiedById], references: [id], onDelete: SetNull)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([tenantId])
  @@index([accountType])
  @@index([isActive])
  @@index([isPrimaryAccount])
}

model PaymentHistory {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  accountId         String
  account           Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  paymentDate       DateTime
  amountDue         Decimal  @db.Decimal(10, 2)
  amountPaid        Decimal? @db.Decimal(10, 2)
  
  status            PaymentStatus @default(UPCOMING)
  
  dueDate           DateTime?
  paidDate          DateTime?
  
  confirmationNumber String?
  paymentMethod     String?
  
  notes             String?  @db.Text
  
  isRecurring       Boolean  @default(false)
  parentPaymentId   String?
  
  calculationMode   CalculationMode @default(AUTOMATIC)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([tenantId])
  @@index([accountId])
  @@index([paymentDate])
  @@index([status])
}

model AccountAttachment {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  fileName    String
  fileUrl     String
  fileType    String
  fileSize    Int
  
  description String?  @db.Text
  category    String?
  
  uploadedById String?
  uploadedBy  User?    @relation(fields: [uploadedById], references: [id], onDelete: SetNull)
  
  uploadedAt  DateTime @default(now())
  
  @@index([tenantId])
  @@index([accountId])
}

// ============================================
// POWER OF ATTORNEY SYSTEM - ADDED MODELS
// ============================================
// These models are ADDED to your existing schema
// Your existing models (Delegate, User, etc.) are UNCHANGED
// ============================================

// POA Enums
enum POAType {
  DURABLE
  GENERAL
  LIMITED
  SPRINGING
  HEALTHCARE
}

enum POAStatus {
  DRAFT
  ACTIVE
  REVOKED
  EXPIRED
  DORMANT
  ACTIVATION_PENDING
  RECOVERED
}

// ============================================
// POWER OF ATTORNEY (Financial)
// ============================================

model PowerOfAttorney {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation("PowerOfAttorneys", fields: [tenantId], references: [id], onDelete: Cascade)
  
  principalUserId String?
  principalUser   User?    @relation("PrincipalPOAs", fields: [principalUserId], references: [id], onDelete: SetNull)
  principalName   String
  principalAddress String
  principalCity   String
  principalState  String
  principalZip    String
  principalDOB    DateTime?
  principalSSN    String?  @db.Text
  principalPhone  String?
  principalEmail  String?
  
  poaType         POAType
  isDurable       Boolean  @default(true)
  isLimited       Boolean  @default(false)
  isSpringing     Boolean  @default(false)
  
  effectiveDate   DateTime?
  effectiveImmediately Boolean @default(true)
  expirationDate  DateTime?
  
  springingStatus         String?
  springingCondition      String?  @db.Text
  requiresPhysicianCert   Boolean  @default(false)
  numberOfPhysiciansReq   Int      @default(1)
  physicianCertifications PhysicianCertification[]
  activatedAt             DateTime?
  activationNotifiedTo    Json?
  recoveryCertification   String?
  recoveredAt             DateTime?
  physicianCertCost       Decimal? @db.Decimal(10, 2)
  
  status          POAStatus @default(DRAFT)
  
  grantedPowers   POAGrantedPower[]
  excludedPowers  Json?
  limitations     String?  @db.Text
  specialInstructions String? @db.Text
  
  intendedUse     String   @default("general")
  willBeRecorded  Boolean  @default(false)
  
  agentCompensation       Boolean  @default(false)
  compensationDetails     String?  @db.Text
  requireDualSignatures   Boolean  @default(false)
  dualSignatureThreshold  Decimal? @db.Decimal(12, 2)
  requireAnnualAccounting Boolean  @default(false)
  
  hasCoAgents             Boolean  @default(false)
  coAgentsMustActJointly  Boolean  @default(false)
  
  notaryBlockType String?
  notaryState     String?
  notaryCounty    String?
  notarizedAt     DateTime?
  notaryName      String?
  notaryCommission String?
  notaryExpiration DateTime?
  onlineNotarization Boolean @default(false)
  
  requiresWitnesses       Boolean  @default(false)
  numberOfWitnesses       Int?
  witnesses               POAWitness[]
  
  state                   String
  usesStatutoryForm       Boolean  @default(false)
  statutoryFormId         String?
  statutoryForm           StatutoryPOAForm? @relation(fields: [statutoryFormId], references: [id])
  
  generatedDocument String?
  signedDocument    String?
  documentTemplateUsed String?
  
  recordedAt        DateTime?
  recordingCounty   String?
  recordingBookPage String?
  
  agents            POAAgent[]
  revocations       POARevocation[]
  auditLogs         POAAuditLog[]
  powerLimitations  POAPowerLimitation[]
  
  createdById     String?
  createdBy       User?    @relation("CreatedPOAs", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([principalUserId])
  @@index([status])
  @@index([state])
  @@index([poaType])
}

model POAAgent {
  id              String @id @default(uuid())
  poaId           String
  poa             PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  agentType       String
  order           Int
  
  userId          String?
  user            User?   @relation("UserPOAAgents", fields: [userId], references: [id], onDelete: SetNull)
  fullName        String
  relationship    String?
  email           String?
  phone           String?
  address         String?
  city            String?
  state           String?
  zip             String?
  
  specificPowers  Json?
  
  hasAccepted     Boolean  @default(false)
  acceptedAt      DateTime?
  acceptanceDocument String?
  declinedAt      DateTime?
  declineReason   String?  @db.Text
  
  isCompensated   Boolean  @default(false)
  compensationDetails String? @db.Text
  
  requiresSignature       Boolean @default(false)
  requiresNotarization    Boolean @default(false)
  signedAt                DateTime?
  signatureDocument       String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([poaId])
  @@index([userId])
}

model POAWitness {
  id          String @id @default(uuid())
  poaId       String
  poa         PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  fullName    String
  address     String?
  city        String?
  state       String?
  zip         String?
  relationship String?
  
  signedAt    DateTime?
  signature   String?
  
  isAgent     Boolean @default(false)
  isSpouse    Boolean @default(false)
  isRelative  Boolean @default(false)
  isNotary    Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([poaId])
}

model POAPowerCategoryDefinition {
  id                    String @id @default(uuid())
  
  categoryNumber        Int
  categoryName          String
  categoryLetter        String?
  
  statutoryDefinition   String @db.Text
  plainLanguageDesc     String @db.Text
  
  isDangerous           Boolean @default(false)
  dangerWarningText     String? @db.Text
  
  examples              Json
  stateSpecificNotes    Json?
  
  subPowers             POASubPowerDefinition[]
  grantedPowers         POAGrantedPower[]
  
  effectiveDate         DateTime
  supersededDate        DateTime?
  isCurrentVersion      Boolean @default(true)
  
  sortOrder             Int
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@unique([categoryNumber, effectiveDate])
  @@index([categoryNumber, isCurrentVersion])
}

model POASubPowerDefinition {
  id          String   @id @default(uuid())
  categoryId  String
  category    POAPowerCategoryDefinition @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  powerText   String   @db.Text
  isDangerous Boolean  @default(false)
  citation    String?
  
  sortOrder   Int
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([categoryId])
}

model POAGrantedPower {
  id              String   @id @default(uuid())
  poaId           String
  poa             PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  categoryId      String
  category        POAPowerCategoryDefinition @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  grantedSubPowers Json
  grantAllSubPowers Boolean @default(false)
  
  principalInitials String?
  dateInitialed     DateTime?
  
  limitations     String?  @db.Text
  notes           String?  @db.Text
  
  powerLimitations POAPowerLimitation[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([poaId, categoryId])
  @@index([poaId])
  @@index([categoryId])
}

model PhysicianCertification {
  id              String   @id @default(uuid())
  poaId           String
  poa             PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  certificationNumber Int @default(1)
  
  physicianName   String
  licenseNumber   String
  licenseState    String
  specialty       String?
  address         String
  phone           String
  email           String?
  
  examinationDate DateTime
  examinationLocation String?
  principalName   String
  
  certificationText String @db.Text
  findings        String   @db.Text
  
  isIncapacitated Boolean  @default(true)
  impairmentType  String?
  diagnosis       String?  @db.Text
  functionalFindings Json?
  
  isPermanent     Boolean?
  isTemporary     Boolean?
  expectedRecoveryDate DateTime?
  
  testConducted   Json?
  
  notarizedAt     DateTime?
  notaryName      String?
  notaryState     String?
  
  uploadedDocument String?
  
  acceptedAt      DateTime?
  acceptedById    String?
  rejectedAt      DateTime?
  rejectedById    String?
  rejectionReason String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([poaId])
}

model POARevocation {
  id              String   @id @default(uuid())
  poaId           String
  poa             PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  tenantId        String
  tenant          Tenant   @relation("POARevocations", fields: [tenantId], references: [id], onDelete: Cascade)
  
  revocationType  String
  
  principalName   String
  principalAddress String
  
  revokedAt       DateTime
  revokedById     String?
  revokedBy       User?    @relation("UserPOARevocations", fields: [revokedById], references: [id], onDelete: SetNull)
  
  reason          String?  @db.Text
  affectedAgents  Json?
  
  notifiedParties Json?
  notificationsSent Boolean @default(false)
  
  recordedAt      DateTime?
  recordingCounty String?
  recordingBookPage String?
  
  revocationDocument String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([poaId])
  @@index([tenantId])
}

model POAAuditLog {
  id          String   @id @default(uuid())
  poaId       String
  poa         PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  userId      String?
  user        User?    @relation("UserPOAAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  
  action      String
  category    String
  
  details     Json?
  
  ipAddress   String?
  userAgent   String?  @db.Text
  
  timestamp   DateTime @default(now())
  
  @@index([poaId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

// ============================================
// HEALTHCARE POA
// ============================================

model HealthcarePOA {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation("HealthcarePOAs", fields: [tenantId], references: [id], onDelete: Cascade)
  
  principalUserId   String?
  principalUser     User?    @relation("PrincipalHealthcarePOAs", fields: [principalUserId], references: [id], onDelete: SetNull)
  principalName     String
  principalAddress  String
  principalCity     String
  principalState    String
  principalZip      String
  principalDOB      DateTime?
  principalPhone    String?
  principalEmail    String?
  
  agentName         String
  agentRelationship String?
  agentPhone        String?
  agentEmail        String?
  agentAddress      String?
  
  alternateAgents   Json?
  
  generalMedicalCare Boolean @default(true)
  mentalHealthTreatment Boolean @default(true)
  endOfLifeDecisions Boolean @default(true)
  organDonation     Boolean @default(false)
  autopsyConsent    Boolean @default(false)
  
  endOfLifePreferences String? @db.Text
  organDonationDetails String? @db.Text
  
  specialInstructions String? @db.Text
  
  state             String
  statutoryFormUsed Boolean @default(false)
  
  status            POAStatus @default(DRAFT)
  
  witnesses         HealthcarePOAWitness[]
  auditLogs         HealthcarePOAAuditLog[]
  
  generatedDocument String?
  signedDocument    String?
  
  createdById       String?
  createdBy         User?    @relation("CreatedHealthcarePOAs", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([tenantId])
  @@index([principalUserId])
  @@index([status])
  @@index([state])
}

model HealthcarePOAWitness {
  id              String @id @default(uuid())
  healthcarePOAId String
  healthcarePOA   HealthcarePOA @relation(fields: [healthcarePOAId], references: [id], onDelete: Cascade)
  
  fullName        String
  address         String?
  city            String?
  state           String?
  zip             String?
  relationship    String?
  
  signedAt        DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([healthcarePOAId])
}

model HealthcarePOAAuditLog {
  id              String   @id @default(uuid())
  healthcarePOAId String
  healthcarePOA   HealthcarePOA @relation(fields: [healthcarePOAId], references: [id], onDelete: Cascade)
  
  userId          String?
  user            User?    @relation("UserHealthcarePOAAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  
  action          String
  category        String
  
  details         Json?
  
  timestamp       DateTime @default(now())
  
  @@index([healthcarePOAId])
  @@index([userId])
  @@index([timestamp])
}

// ============================================
// STATE REQUIREMENTS FOR POA
// ============================================

model StateRequirements {
  id          String @id @default(uuid())
  state       String @unique
  stateName String
  
  notarizationRequired      Boolean  @default(true)
  notarizationStronglyRec   Boolean  @default(false)
  
  witnessesRequired         Boolean  @default(false)
  numberOfWitnesses         Int?
  minimumWitnessAge         Int      @default(18)
  witnessesOrNotary         Boolean  @default(false)
  
  agentCannotBeWitness      Boolean  @default(true)
  notaryCannotBeWitness     Boolean  @default(false)
  spouseCannotBeWitness     Boolean  @default(false)
  relativesCannotBeWitness  Boolean  @default(false)
  witnessRestrictions       String?  @db.Text
  
  hasStatutoryForm          Boolean  @default(false)
  statutoryFormRequired     Boolean  @default(false)
  statutoryFormCitation     String?
  statutoryFormNotes        String?  @db.Text
  
  durabilityRequired        Boolean  @default(true)
  durabilityWording         String?  @db.Text
  defaultDurability         String   @default("durable")
  
  allowsSpringing           Boolean  @default(true)
  springingBannedReason     String?
  numberOfPhysiciansRequired Int     @default(1)
  courtDeterminationAllowed Boolean  @default(false)
  
  requiresAgentSignature    Boolean  @default(false)
  requiresAgentNotarization Boolean  @default(false)
  agentAcceptanceWording    String?  @db.Text
  
  requiredPrincipalNotice   String?  @db.Text
  requiredAgentNotice       String?  @db.Text
  
  recordingMandatoryFor     Json?
  recordingInstructions     String?  @db.Text
  estimatedRecordingFee     Decimal? @db.Decimal(6, 2)
  
  hotPowersRequireSeparateConsent Boolean @default(false)
  hotPowersList             Json?
  giftingAnnualLimit        Decimal? @db.Decimal(10, 2)
  
  specialNotes              String?  @db.Text
  strictnessLevel           String   @default("standard")
  
  allowsRemoteNotarization  Boolean  @default(true)
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  @@index([state])
}

model NotaryBlockTemplate {
  id              String @id @default(uuid())
  
  state           String
  documentType    String
  
  templateText    String @db.Text
  
  statutoryCitation String?
  effectiveDate     DateTime
  supersededDate    DateTime?
  isCurrentVersion  Boolean @default(true)
  
  requiresWitnesses Boolean @default(false)
  numberOfWitnesses Int?
  witnessRelationshipRules String? @db.Text
  requiresNotary    Boolean @default(true)
  notaryCanBeWitness Boolean @default(false)
  
  requiresMaritalStatus   Boolean @default(false)
  requiresCommissionNumber Boolean @default(false)
  requiresSeal            Boolean @default(true)
  allowsOnlineNotarization Boolean @default(false)
  
  specialInstructions     String? @db.Text
  commonRejectionReasons  String? @db.Text
  
  uploadedById    String?
  uploadedBy      User?   @relation("UploadedNotaryTemplates", fields: [uploadedById], references: [id], onDelete: SetNull)
  
  usageCount      Int     @default(0)
  lastUsedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([state, documentType, effectiveDate])
  @@index([state, documentType, isCurrentVersion])
}

model IncapacityDefinition {
  id              String   @id @default(uuid())
  state           String   @unique
  
  definitionType  String
  
  statutoryText   String   @db.Text
  plainLanguage   String   @db.Text
  
  isUPOAAState    Boolean  @default(false)
  includesMissing Boolean  @default(false)
  includesAbroad  Boolean  @default(false)
  
  requiresCognitiveTesting Boolean @default(false)
  requiresFunctionalAssess Boolean @default(false)
  requiresSpecificDiagnosis Boolean @default(false)
  
  physicianGuidance String? @db.Text
  exampleFindings   String? @db.Text
  
  specialNotes    String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([state])
}

model HealthcarePOAStateForm {
  id              String   @id @default(uuid())
  state           String   @unique
  stateName       String
  
  formName        String
  pdfLink         String
  spanishLink     String?
  
  requiresNotary  Boolean
  requiresWitnesses Boolean
  numberOfWitnesses Int?
  notaryOrWitnesses Boolean @default(false)
  
  witnessRestrictions String? @db.Text
  
  includesDNR     Boolean @default(false)
  includesPOLST   Boolean @default(false)
  includesOrganDonation Boolean @default(true)
  includesLivingWill Boolean @default(false)
  
  specialInstructions String? @db.Text
  commonMistakes      String? @db.Text
  
  lastUpdated     DateTime
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([state])
}

model StatutoryPOAForm {
  id              String   @id @default(uuid())
  state           String
  
  formName        String
  citation        String
  effectiveDate   DateTime
  supersededDate  DateTime?
  isCurrentVersion Boolean @default(true)
  
  blankFormPath   String?
  fillableForm    Boolean  @default(false)
  formInstructions String? @db.Text
  
  powerCount      Int
  powers          Json
  
  hasAllOption    Boolean  @default(true)
  allOptionLabel  String?
  
  hasGiftsRider   Boolean  @default(false)
  giftsRiderPath  String?
  
  requiresAgentSig          Boolean @default(false)
  requiresSeparateAgentDoc  Boolean @default(false)
  
  hasMonitors     Boolean  @default(false)
  hasCoAgents     Boolean  @default(false)
  
  principalNotice String   @db.Text
  agentNotice     String   @db.Text
  
  witnessesRequired         String
  witnessRestrictions       String?  @db.Text
  notaryRequired            Boolean  @default(true)
  notaryBlockTemplate       String   @db.Text
  
  userGuidance    String?  @db.Text
  commonMistakes  String?  @db.Text
  
  uploadedById    String?
  uploadedBy      User?    @relation("UploadedStatutoryForms", fields: [uploadedById], references: [id], onDelete: SetNull)
  
  usageCount      Int      @default(0)
  lastUsedAt      DateTime?
  
  powerOfAttorneys PowerOfAttorney[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([state, effectiveDate])
  @@index([state, isCurrentVersion])
}

model StateSpecialRequirement {
  id              String @id @default(uuid())
  state           String
  requirementType String
  
  title           String
  description     String @db.Text
  citation        String?
  
  appliesTo       Json
  
  isMandatory     Boolean
  severity        String
  
  userGuidance    String @db.Text
  complianceSteps Json
  
  rejectionRisk   String?
  rejectedBy      Json?
  
  effectiveDate   DateTime
  supersededDate  DateTime?
  isActive        Boolean @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([state, requirementType, isActive])
}


// ============================================
// WIZARD PROGRESS TRACKING
// ============================================

model WizardProgress {
  id                String  @id @default(uuid())
  
  tenantId          String
  tenant            Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  documentType      String
  sessionId         String  @unique
  
  currentSection    String
  currentStep       String
  completedSections Json
  completedSteps    Json
  
  formData          Json
  validationErrors  Json?
  
  estimatedCompletion Int?
  timeSpent         Int     @default(0)
  lastActivity      DateTime @default(now())
  
  isCompleted       Boolean @default(false)
  isAbandoned       Boolean @default(false)
  abandonedReason   String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([tenantId, userId, documentType])
  @@index([userId])
  @@index([sessionId])
  @@index([lastActivity])
}

// ============================================
// POA POWER LIMITATIONS (NEWLY ADDED)
// ============================================

model POAPowerLimitation {
  id                String   @id @default(cuid())
  poaId             String
  grantedPowerId    String
  
  limitationType    String   // "SCOPE", "MONETARY", "TIME", "GEOGRAPHIC", "SPECIFIC_ASSET", "NO_LIMITATION"
  limitationText    String   @db.Text
  
  monetaryLimit     Decimal? @db.Decimal(15, 2)
  timeLimit         DateTime?
  geographicLimit   String?
  specificAsset     String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  poa               PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  grantedPower      POAGrantedPower @relation(fields: [grantedPowerId], references: [id], onDelete: Cascade)
  
  @@index([poaId])
  @@index([grantedPowerId])
  @@index([limitationType])
}

// ============================================
// LIMITED POA TEMPLATES (NEWLY ADDED)
// ============================================

model LimitedPOATemplate {
  id                      String   @id @default(cuid())
  
  name                    String   // "Real Estate Purchase", "Vehicle Sale", etc.
  description             String   @db.Text
  
  requiredPowerCategories String[] // Array of category IDs needed
  defaultLimitations      Json     // Structured limitation data
  
  commonUseCase           String   @db.Text
  
  isActive                Boolean  @default(true)
  sortOrder               Int      @default(0)
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  @@index([isActive])
  @@index([sortOrder])
}

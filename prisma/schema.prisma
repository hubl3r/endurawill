// Endurawill - Production-Ready Database Schema
// Built for scale, audit trails, and granular permissions
// Version: 2.2 - Added Scalable Wizard Architecture & Power Limitations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

// Account Management Enums
enum PaymentFrequency {
  NONE
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
  ONE_TIME
  OTHER
}

enum PaymentStatus {
  UPCOMING
  PAID
  PAST_DUE
  PARTIAL
  SKIPPED
}

enum CalculationMode {
  AUTOMATIC
  MANUAL
}

// ============================================
// TENANT = An Estate (Individual or Joint)
// ============================================
model Tenant {
  id          String   @id @default(uuid())
  name        String?
  type        String   @default("individual")
  
  maxOwners   Int      @default(1)
  ownerCount  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users              User[]
  documents          Document[]
  assets             Asset[]
  liabilities        Liability[]
  beneficiaries      Beneficiary[]
  directives         Directive[]
  finalArrangements  FinalArrangement[]
  delegates          Delegate[]
  settings           TenantSettings?
  auditLogs          AuditLog[]
  accounts           Account[]
  paymentHistory     PaymentHistory[]
  accountAttachments AccountAttachment[]
  
  // POA Relations
  powerOfAttorneys   PowerOfAttorney[] @relation("PowerOfAttorneys")
  healthcarePOAs     HealthcarePOA[] @relation("HealthcarePOAs")
  poaRevocations     POARevocation[] @relation("POARevocations")
  
  // NEW: Wizard System Relations
  wizardProgress     WizardProgress[]
  
  @@index([type])
}

// ============================================
// USER = A person with access to the estate
// ============================================
model User {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clerkId    String
  
  role       String
  isPrimary  Boolean  @default(false)
  
  fullName   String
  email      String?
  dob        DateTime?
  phone      String?
  
  profile    Profile?
  
  twoFactorEnabled Boolean @default(false)
  
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sessions              Session[]
  auditLogs             AuditLog[]
  createdDocuments      Document[] @relation("CreatedBy")
  modifiedDocuments     Document[] @relation("ModifiedBy")
  comments              Comment[]
  resourcePermissions   ResourcePermission[]
  delegateRecord        Delegate? @relation("DelegateUser")
  invitedDelegates      Delegate[] @relation("InvitedBy")
  createdAccounts       Account[] @relation("AccountCreatedBy")
  modifiedAccounts      Account[] @relation("AccountModifiedBy")
  uploadedAttachments   AccountAttachment[]
  
  // POA Relations
  principalPOAs         PowerOfAttorney[] @relation("PrincipalPOAs")
  agentPOAs             POAAgent[] @relation("UserPOAAgents")
  createdPOAs           PowerOfAttorney[] @relation("CreatedPOAs")
  revokedPOAs           POARevocation[] @relation("UserPOARevocations")
  poaAuditLogs          POAAuditLog[] @relation("UserPOAAuditLogs")
  principalHealthcarePOAs HealthcarePOA[] @relation("PrincipalHealthcarePOAs")
  createdHealthcarePOAs HealthcarePOA[] @relation("CreatedHealthcarePOAs")
  healthcarePOAAuditLogs HealthcarePOAAuditLog[] @relation("UserHealthcarePOAAuditLogs")
  uploadedStatutoryForms StatutoryPOAForm[] @relation("UploadedStatutoryForms")
  uploadedNotaryTemplates NotaryBlockTemplate[] @relation("UploadedNotaryTemplates")
  
  // NEW: Wizard System Relations
  wizardProgress        WizardProgress[]
  
  @@unique([tenantId, clerkId])
  @@index([clerkId])
  @@index([tenantId])
  @@index([role])
}

// ============================================
// PROFILE = Extended info for estate owners
// ============================================
model Profile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  stateResidence  String?
  maritalStatus   String?
  
  goals           Json?
  complexityLevel String?
  selectedPlan    String?
  
  hasCompletedOnboarding Boolean @default(false)
  onboardingStep  Int     @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  children        Child[]
  pets            Pet[]
}

// ============================================
// CHILD = Profile's children
// ============================================
model Child {
  id           String   @id @default(uuid())
  profileId    String
  profile      Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  fullName     String
  dob          DateTime?
  relationship String   @default("child")
  isMinor      Boolean  @default(true)
  
  guardianPreference String?
  beneficiaryId String?
  notes        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([profileId])
}

// ============================================
// PET = Profile's pets
// ============================================
model Pet {
  id             String   @id @default(uuid())
  profileId      String
  profile        Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  name           String
  type           String
  breed          String?
  age            Int?
  
  specialNeeds   String?
  vetInfo        Json?
  careInstructions String?
  
  caretakerPreference String?
  trustFund       Boolean @default(false)
  trustAmount     Decimal? @db.Decimal(15, 2)
  
  notes          String?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([profileId])
}

// ============================================
// RESOURCE PERMISSION = Granular access control
// ============================================
model ResourcePermission {
  id           String   @id @default(uuid())
  tenantId     String
  
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  resourceType String
  resourceId   String?
  documentType String?
  
  canView      Boolean  @default(false)
  canEdit      Boolean  @default(false)
  canDelete    Boolean  @default(false)
  canDownload  Boolean  @default(false)
  canShare     Boolean  @default(false)
  canModifyPermissions Boolean @default(false)
  
  grantedBy    String
  grantedAt    DateTime @default(now())
  revokedBy    String?
  revokedAt    DateTime?
  isActive     Boolean  @default(true)
  
  reason       String?
  notes        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([userId, resourceType, resourceId, documentType])
  @@index([userId])
  @@index([tenantId])
  @@index([resourceType, resourceId])
  @@index([isActive])
  @@index([documentType])
}

// ============================================
// TENANT SETTINGS = Estate-wide preferences
// ============================================
model TenantSettings {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  requireBothOwnersApproval Boolean @default(false)
  primaryCanOverride        Boolean @default(true)
  
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)
  notifyOnDelegateAccess Boolean @default(true)
  
  require2FA         Boolean @default(false)
  sessionTimeout     Int     @default(30)
  ipWhitelist        Json?
  
  autoVersioning     Boolean @default(true)
  retentionPeriod    Int     @default(50)
  
  allowDelegateInvite Boolean @default(true)
  requireDelegateApproval Boolean @default(true)
  maxDelegates       Int     @default(10)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// SESSION = User authentication sessions
// ============================================
model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sessionId String   @unique
  clientIP  String?
  userAgent String?
  
  isActive  Boolean  @default(true)
  lastSeen  DateTime @default(now())
  expiresAt DateTime
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId, isActive])
  @@index([sessionId])
}

// ============================================
// DOCUMENT = Files and folders in the system
// ============================================
model Document {
  id          String   @id @default(uuid())
  title       String
  description String?
  
  isFolder    Boolean  @default(false)
  type        String?
  parentId    String?
  parent      Document? @relation("SubDocuments", fields: [parentId], references: [id])
  children    Document[] @relation("SubDocuments")
  
  status      String   @default("active")
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdById  String
  createdBy    User     @relation("CreatedBy", fields: [createdById], references: [id])
  
  modifiedById String?
  modifiedBy   User?    @relation("ModifiedBy", fields: [modifiedById], references: [id])
  
  fileUrl     String?
  fileName    String?
  fileType    String?
  fileSize    Int?
  
  content     Json?
  
  tags        String[]
  
  isShared    Boolean  @default(false)
  sharedWith  String[]
  
  isPublic    Boolean  @default(false)
  publicUrl   String?
  
  version     Int      @default(1)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  comments    Comment[]
  
  @@index([tenantId])
  @@index([createdById])
  @@index([type])
  @@index([status])
  @@index([parentId])
}

// ============================================
// COMMENT = Document comments
// ============================================
model Comment {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  
  content    String   @db.Text
  isResolved Boolean  @default(false)
  
  parentId   String?
  parent     Comment? @relation("Replies", fields: [parentId], references: [id])
  replies    Comment[] @relation("Replies")
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([documentId])
  @@index([userId])
}

// ============================================
// ASSET = Assets in the estate
// ============================================
model Asset {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  category     String
  subcategory  String?
  name         String
  description  String?
  
  currentValue Decimal? @db.Decimal(15, 2)
  basisValue   Decimal? @db.Decimal(15, 2)
  
  location     String?
  accountNumber String?
  
  isJointlyOwned Boolean @default(false)
  ownershipPercentage Decimal? @db.Decimal(5, 2)
  
  beneficiaryDesignation String?
  
  metadata     Json?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([tenantId])
  @@index([category])
}

// ============================================
// LIABILITY = Debts and liabilities
// ============================================
model Liability {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type        String
  creditor    String
  description String?
  
  balance     Decimal  @db.Decimal(15, 2)
  monthlyPayment Decimal? @db.Decimal(10, 2)
  
  isSecured   Boolean  @default(false)
  collateral  String?
  
  accountNumber String?
  
  metadata    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([type])
}

// ============================================
// BENEFICIARY = People who inherit
// ============================================
model Beneficiary {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type         String
  fullName     String
  relationship String?
  
  contactInfo  Json?
  address      Json?
  
  percentage   Decimal? @db.Decimal(5, 2)
  contingent   Boolean  @default(false)
  
  notes        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([tenantId])
  @@index([type])
}

// ============================================
// DIRECTIVE = Healthcare and personal directives
// ============================================
model Directive {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type        String
  title       String
  content     String   @db.Text
  
  isActive    Boolean  @default(true)
  effectiveDate DateTime?
  expirationDate DateTime?
  
  witnessInfo Json?
  notaryInfo  Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([type])
}

// ============================================
// FINAL ARRANGEMENT = End-of-life preferences
// ============================================
model FinalArrangement {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type          String
  preferences   Json
  
  servicePlans  Json?
  contactInfo   Json?
  
  specialInstructions String? @db.Text
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tenantId])
}

// ============================================
// DELEGATE = Temporary access users
// ============================================
model Delegate {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId      String?  @unique
  user        User?    @relation("DelegateUser", fields: [userId], references: [id])
  
  email       String
  fullName    String
  role        String
  
  invitedById String?
  invitedBy   User?    @relation("InvitedBy", fields: [invitedById], references: [id])
  
  permissions Json     @default("{}")
  
  status      String   @default("pending")
  expiresAt   DateTime
  
  acceptedAt  DateTime?
  revokedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([email])
  @@index([status])
}

// ============================================
// AUDIT LOG = System audit trail
// ============================================
model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  action    String
  resource  String   @default("unknown")
  resourceId String?
  
  oldValues Json?
  newValues Json?
  
  ipAddress String?
  userAgent String?
  
  timestamp DateTime @default(now())
  
  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

// ============================================
// ACCOUNT MANAGEMENT SYSTEM
// ============================================
model Account {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  accountName     String
  accountType     String   @default("checking")
  institution     String?
  
  accountNumber   String?
  routingNumber   String?
  
  currentBalance  Decimal? @db.Decimal(15, 2)
  availableBalance Decimal? @db.Decimal(15, 2)
  
  isActive        Boolean  @default(true)
  isLinked        Boolean  @default(false)
  
  linkProvider    String?
  linkAccountId   String?
  linkAccessToken String?
  lastSynced      DateTime?
  
  paymentFrequency PaymentFrequency @default(NONE)
  paymentAmount   Decimal?          @db.Decimal(10, 2)
  nextPaymentDate DateTime?
  
  calculationMode CalculationMode   @default(AUTOMATIC)
  manualBalance   Decimal?          @db.Decimal(15, 2)
  
  notes           String?
  
  createdById     String
  createdBy       User    @relation("AccountCreatedBy", fields: [createdById], references: [id])
  
  modifiedById    String?
  modifiedBy      User?   @relation("AccountModifiedBy", fields: [modifiedById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  paymentHistory  PaymentHistory[]
  attachments     AccountAttachment[]
  
  @@index([tenantId])
  @@index([accountType])
  @@index([isActive])
}

model PaymentHistory {
  id           String        @id @default(uuid())
  tenantId     String
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  accountId    String
  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  paymentDate  DateTime
  amount       Decimal       @db.Decimal(10, 2)
  status       PaymentStatus @default(UPCOMING)
  
  description  String?
  reference    String?
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  @@index([tenantId])
  @@index([accountId])
  @@index([paymentDate])
}

model AccountAttachment {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  accountId    String
  account      Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  fileName     String
  fileType     String
  fileSize     Int
  fileUrl      String
  
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([tenantId])
  @@index([accountId])
}

// ============================================
// POWER OF ATTORNEY SYSTEM
// ============================================
model PowerOfAttorney {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation("PowerOfAttorneys", fields: [tenantId], references: [id], onDelete: Cascade)
  
  principalUserId   String
  principalUser     User     @relation("PrincipalPOAs", fields: [principalUserId], references: [id])
  
  principalName     String
  principalAddress  String?
  principalCity     String?
  principalState    String?
  principalZip      String?
  principalEmail    String?
  principalPhone    String?
  principalDOB      DateTime?
  
  state             String
  poaType           String
  isDurable         Boolean  @default(false)
  isLimited         Boolean  @default(false)
  isSpringing       Boolean  @default(false)
  
  effectiveImmediately    Boolean @default(true)
  expirationDate          DateTime?
  
  springingCondition      String?
  requiresPhysicianCert   Boolean @default(false)
  numberOfPhysiciansReq   Int     @default(1)
  
  status            String   @default("draft")
  
  hasCoAgents             Boolean @default(false)
  coAgentsMustActJointly  Boolean @default(false)
  
  usesStatutoryForm Boolean  @default(false)
  specialInstructions String? @db.Text
  
  notaryName        String?
  notaryCommission  String?
  notaryExpiration  DateTime?
  notaryCounty      String?
  notaryState       String?
  
  generatedDocument String?
  
  createdById       String
  createdBy         User     @relation("CreatedPOAs", fields: [createdById], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // NEW: Enhanced Professional Features
  limitations       PowerLimitation[]
  authorityType     String? // "standard", "broad", "limited"
  liabilityWaiver   String? // "none", "good_faith", "full"
  compensationType  String? // "none", "reasonable", "hourly", "percentage"
  hourlyRate        Decimal? @db.Decimal(8, 2)
  useStatutoryForm  Boolean @default(false)
  statutoryFormId   String?
  statutoryForm     StatutoryPOAForm? @relation(fields: [statutoryFormId], references: [id])
  
  agents            POAAgent[]
  grantedPowers     POAGrantedPower[]
  witnesses         POAWitness[]
  auditLogs         POAAuditLog[]
  revocations       POARevocation[]
  
  @@index([tenantId])
  @@index([principalUserId])
  @@index([state])
  @@index([poaType])
  @@index([status])
}

model POAAgent {
  id            String  @id @default(uuid())
  poaId         String
  poa           PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  userId        String?
  user          User?   @relation("UserPOAAgents", fields: [userId], references: [id])
  
  agentType     String
  order         Int     @default(1)
  
  fullName      String
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  zip           String?
  relationship  String?
  
  hasAccepted   Boolean @default(false)
  acceptedAt    DateTime?
  declinedAt    DateTime?
  requiresSignature Boolean @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([poaId])
  @@index([userId])
}

// UPDATED: Enhanced POAGrantedPower with limitations support
model POAGrantedPower {
  id                String  @id @default(uuid())
  poaId             String
  poa               PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  categoryId        String
  category          PowerCategory @relation(fields: [categoryId], references: [id])
  
  grantAllSubPowers Boolean @default(true)
  grantedSubPowers  Json?
  
  // NEW: Limitation tracking
  hasLimitations    Boolean @default(false)
  limitationCount   Int     @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([poaId, categoryId])
  @@index([poaId])
  @@index([categoryId])
}

model POAWitness {
  id        String  @id @default(uuid())
  poaId     String
  poa       PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  fullName  String
  address   String?
  city      String?
  state     String?
  zip       String?
  relationship String?
  
  signedAt  DateTime?
  signature String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([poaId])
}

model POAAuditLog {
  id        String  @id @default(uuid())
  poaId     String
  poa       PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  userId    String?
  user      User?   @relation("UserPOAAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  
  action    String
  category  String
  details   Json?
  
  ipAddress String?
  userAgent String?
  
  timestamp DateTime @default(now())
  
  @@index([poaId])
  @@index([userId])
}

model POARevocation {
  id              String  @id @default(uuid())
  tenantId        String
  tenant          Tenant  @relation("POARevocations", fields: [tenantId], references: [id], onDelete: Cascade)
  
  originalPOAId   String
  originalPOA     PowerOfAttorney @relation(fields: [originalPOAId], references: [id])
  
  userId          String
  user            User    @relation("UserPOARevocations", fields: [userId], references: [id])
  
  reason          String?
  revocationDate  DateTime @default(now())
  notifiedParties Json?
  
  generatedDocument String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([originalPOAId])
  @@index([userId])
}

// ============================================
// NEW: POWER LIMITATIONS SYSTEM
// ============================================

// Power categories with state-specific configurations
model PowerCategory {
  id                  String  @id @default(uuid())
  
  // Core category info
  categoryName        String  // "Real Estate", "Banking", etc.
  shortCode          String  // "RE", "BANK", etc.
  plainLanguageDesc  String  @db.Text
  
  // State-specific configurations
  state              String
  letterCode         String? // "a", "b", "c" for Tennessee-style
  isStandardPower    Boolean @default(true)
  isHotPower         Boolean @default(false)
  
  // Legal text and descriptions
  statutoryLanguage  String  @db.Text
  exampleActions     Json?   // Array of example actions
  commonLimitations  Json?   // Array of common limitation types
  
  // Ordering and display
  displayOrder       Int
  isActive          Boolean @default(true)
  
  // Relations
  grantedPowers     POAGrantedPower[]
  limitations       PowerLimitation[]
  subPowers         SubPower[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([state, shortCode])
  @@index([state, isActive])
}

// Sub-powers within categories (optional granular control)
model SubPower {
  id                String  @id @default(uuid())
  categoryId        String
  category          PowerCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  subPowerName      String
  shortCode         String
  description       String  @db.Text
  
  // Examples: Under "Banking" -> "Open accounts", "Close accounts", "Wire transfers"
  isHighRisk        Boolean @default(false)
  requiresSeparateConsent Boolean @default(false)
  
  displayOrder      Int
  isActive          Boolean @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([categoryId, shortCode])
  @@index([categoryId])
}

// Individual power limitations per POA
model PowerLimitation {
  id                String  @id @default(uuid())
  
  // Link to POA and power
  poaId             String
  poa               PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  categoryId        String
  category          PowerCategory @relation(fields: [categoryId], references: [id])
  
  // Limitation type and configuration
  limitationType    String  // "financial_cap", "approval_requirement", "prohibition", "time_restriction", "custom"
  
  // Financial caps
  dollarLimit       Decimal? @db.Decimal(15, 2)
  transactionLimit  Decimal? @db.Decimal(15, 2)
  monthlyLimit      Decimal? @db.Decimal(15, 2)
  annualLimit       Decimal? @db.Decimal(15, 2)
  
  // Approval requirements
  requiresCoAgent   Boolean @default(false)
  requiresCourtApproval Boolean @default(false)
  requiresFamilyNotification Boolean @default(false)
  notificationDays  Int?    // Days advance notice required
  notificationParties Json? // Array of people to notify
  
  // Prohibitions
  prohibitSelfDealing Boolean @default(false)
  prohibitGifting    Boolean @default(false)
  prohibitBeneficiaryChanges Boolean @default(false)
  prohibitedActions  Json?   // Array of specific prohibited actions
  
  // Time restrictions
  effectiveDate     DateTime?
  expirationDate    DateTime?
  limitedDuration   String?  // "90 days", "1 year", etc.
  daysOfWeek        Json?    // Array of allowed days
  hoursOfDay        Json?    // Allowed time ranges
  
  // Custom limitations
  customText        String?  @db.Text
  customConditions  Json?    // Structured custom conditions
  
  // Monitoring and reporting
  requiresMonthlyReport Boolean @default(false)
  requiresQuarterlyReport Boolean @default(false)
  reportingParties  Json?    // Who gets reports
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([poaId, categoryId, limitationType])
  @@index([poaId])
  @@index([categoryId])
}

// ============================================
// NEW: WIZARD PROGRESS TRACKING
// ============================================

model WizardProgress {
  id                String  @id @default(uuid())
  
  tenantId          String
  tenant            Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Wizard identification
  documentType      String  // "financial-poa", "medical-poa", "will", "trust"
  sessionId         String  @unique
  
  // Progress tracking
  currentSection    String
  currentStep       String
  completedSections Json    // Array of completed section IDs
  completedSteps    Json    // Array of completed step IDs
  
  // Form data (encrypted for sensitive info)
  formData          Json    // All form data as JSON
  validationErrors  Json?   // Current validation errors
  
  // Timing and metadata
  estimatedCompletion Int?  // Minutes
  timeSpent         Int     @default(0) // Minutes
  lastActivity      DateTime @default(now())
  
  // Status
  isCompleted       Boolean @default(false)
  isAbandoned       Boolean @default(false)
  abandonedReason   String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([tenantId, userId, documentType])
  @@index([userId])
  @@index([sessionId])
  @@index([lastActivity])
}

// ============================================
// STATE-SPECIFIC POWER CONFIGURATIONS
// ============================================

model StatePowerConfiguration {
  id                String  @id @default(uuid())
  
  state             String
  powerCategoryId   String
  
  // State-specific overrides
  isRecognized      Boolean @default(true)
  isRecommended     Boolean @default(true)
  requiresSpecialConsent Boolean @default(false)
  
  // Display and legal text
  stateSpecificName String?
  stateLanguage     String? @db.Text
  warningText       String? @db.Text
  
  // Common limitations for this state/power combo
  recommendedLimitations Json? // Array of limitation templates
  prohibitedActions Json?      // Actions banned by state law
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([state, powerCategoryId])
  @@index([state])
}

// ============================================
// HEALTHCARE POA SYSTEM (EXISTING)
// ============================================
model HealthcarePOA {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation("HealthcarePOAs", fields: [tenantId], references: [id], onDelete: Cascade)
  
  principalUserId String
  principalUser   User     @relation("PrincipalHealthcarePOAs", fields: [principalUserId], references: [id])
  
  principalName   String
  principalAddress String?
  principalCity   String?
  principalState  String?
  principalZip    String?
  principalEmail  String?
  principalPhone  String?
  principalDOB    DateTime?
  
  state           String
  
  // Healthcare Powers
  medicalTreatment      Boolean @default(true)
  mentalHealthTreatment Boolean @default(false)
  endOfLifeDecisions    Boolean @default(false)
  organDonation         Boolean @default(false)
  autopsyDecision       Boolean @default(false)
  dispositionOfRemains  Boolean @default(false)
  
  // Healthcare Preferences
  lifeSustainingTreatment String? // 'prolong_life', 'comfort_care_only', 'agent_decides'
  organDonationPreference String? // 'any_needed', 'transplant_only', 'research_only', 'no_donation'
  
  // Limitations
  nutritionHydrationRestrictions String? @db.Text
  experimentalTreatmentLimits    String? @db.Text
  psychiatricTreatmentLimits     String? @db.Text
  
  additionalDirectives String? @db.Text
  specialInstructions  String? @db.Text
  
  status          String   @default("draft")
  
  notaryName      String?
  notaryCommission String?
  notaryExpiration DateTime?
  notaryCounty    String?
  notaryState     String?
  
  generatedDocument String?
  
  createdById     String
  createdBy       User     @relation("CreatedHealthcarePOAs", fields: [createdById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  agents          HealthcarePOAAgent[]
  witnesses       HealthcarePOAWitness[]
  auditLogs       HealthcarePOAAuditLog[]
  
  @@index([tenantId])
  @@index([principalUserId])
  @@index([state])
  @@index([status])
}

model HealthcarePOAAgent {
  id            String  @id @default(uuid())
  healthcarePOAId String
  healthcarePOA HealthcarePOA @relation(fields: [healthcarePOAId], references: [id], onDelete: Cascade)
  
  agentType     String
  order         Int     @default(1)
  
  fullName      String
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  zip           String?
  relationship  String?
  
  hasAccepted   Boolean @default(false)
  acceptedAt    DateTime?
  declinedAt    DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([healthcarePOAId])
}

model HealthcarePOAWitness {
  id              String @id @default(uuid())
  healthcarePOAId String
  healthcarePOA   HealthcarePOA @relation(fields: [healthcarePOAId], references: [id], onDelete: Cascade)
  
  fullName        String
  address         String?
  city            String?
  state           String?
  zip             String?
  relationship    String?
  
  signedAt        DateTime?
  signature       String?
  
  isAgent         Boolean @default(false)
  isHealthcareProvider Boolean @default(false)
  isFacilityOwner Boolean @default(false)
  isRelative      Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([healthcarePOAId])
}

model HealthcarePOAAuditLog {
  id              String @id @default(uuid())
  healthcarePOAId String
  healthcarePOA   HealthcarePOA @relation(fields: [healthcarePOAId], references: [id], onDelete: Cascade)
  
  userId          String?
  user            User?  @relation("UserHealthcarePOAAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  
  action          String
  category        String
  details         Json?
  
  timestamp       DateTime @default(now())
  
  @@index([healthcarePOAId])
  @@index([userId])
}

model StateRequirements {
  id        String   @id @default(uuid())
  state     String   @unique
  stateName String
  
  notarizationRequired      Boolean  @default(true)
  notarizationStronglyRec   Boolean  @default(false)
  
  witnessesRequired         Boolean  @default(false)
  numberOfWitnesses         Int?
  minimumWitnessAge         Int      @default(18)
  witnessesOrNotary         Boolean  @default(false)
  
  agentCannotBeWitness      Boolean  @default(true)
  notaryCannotBeWitness     Boolean  @default(false)
  spouseCannotBeWitness     Boolean  @default(false)
  relativesCannotBeWitness  Boolean  @default(false)
  witnessRestrictions       String?  @db.Text
  
  hasStatutoryForm          Boolean  @default(false)
  statutoryFormRequired     Boolean  @default(false)
  statutoryFormCitation     String?
  statutoryFormNotes        String?  @db.Text
  
  durabilityRequired        Boolean  @default(true)
  durabilityWording         String?  @db.Text
  defaultDurability         String   @default("durable")
  
  allowsSpringing           Boolean  @default(true)
  springingBannedReason     String?
  numberOfPhysiciansRequired Int     @default(1)
  courtDeterminationAllowed Boolean  @default(false)
  
  requiresAgentSignature    Boolean  @default(false)
  requiresAgentNotarization Boolean  @default(false)
  agentAcceptanceWording    String?  @db.Text
  
  requiredPrincipalNotice   String?  @db.Text
  requiredAgentNotice       String?  @db.Text
  
  recordingMandatoryFor     Json?
  recordingInstructions     String?  @db.Text
  estimatedRecordingFee     Decimal? @db.Decimal(6, 2)
  
  hotPowersRequireSeparateConsent Boolean @default(false)
  hotPowersList             Json?
  giftingAnnualLimit        Decimal? @db.Decimal(10, 2)
  
  specialNotes              String?  @db.Text
  strictnessLevel           String   @default("standard")
  
  allowsRemoteNotarization  Boolean  @default(true)
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  @@index([state])
}

model NotaryBlockTemplate {
  id              String @id @default(uuid())
  
  state           String
  documentType    String
  
  templateText    String @db.Text
  
  statutoryCitation String?
  effectiveDate     DateTime
  supersededDate    DateTime?
  isCurrentVersion  Boolean @default(true)
  
  requiresWitnesses Boolean @default(false)
  numberOfWitnesses Int?
  witnessRelationshipRules String? @db.Text
  requiresNotary    Boolean @default(true)
  notaryCanBeWitness Boolean @default(false)
  
  requiresMaritalStatus   Boolean @default(false)
  requiresCommissionNumber Boolean @default(false)
  requiresSeal            Boolean @default(true)
  allowsOnlineNotarization Boolean @default(false)
  
  specialInstructions     String? @db.Text
  commonRejectionReasons  String? @db.Text
  
  uploadedById    String?
  uploadedBy      User?   @relation("UploadedNotaryTemplates", fields: [uploadedById], references: [id], onDelete: SetNull)
  
  usageCount      Int     @default(0)
  lastUsedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([state, documentType, effectiveDate])
  @@index([state, documentType, isCurrentVersion])
}

model IncapacityDefinition {
  id              String   @id @default(uuid())
  state           String   @unique
  
  definitionType  String
  
  statutoryText   String   @db.Text
  plainLanguage   String   @db.Text
  
  isUPOAAState    Boolean  @default(false)
  includesMissing Boolean  @default(false)
  includesAbroad  Boolean  @default(false)
  
  requiresCognitiveTesting Boolean @default(false)
  requiresFunctionalAssess Boolean @default(false)
  requiresSpecificDiagnosis Boolean @default(false)
  
  physicianGuidance String? @db.Text
  exampleFindings   String? @db.Text
  
  specialNotes    String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([state])
}

model HealthcarePOAStateForm {
  id              String   @id @default(uuid())
  state           String   @unique
  stateName       String
  
  formName        String
  pdfLink         String
  spanishLink     String?
  
  requiresNotary  Boolean
  requiresWitnesses Boolean
  numberOfWitnesses Int?
  notaryOrWitnesses Boolean @default(false)
  
  witnessRestrictions String? @db.Text
  
  includesDNR     Boolean @default(false)
  includesPOLST   Boolean @default(false)
  includesOrganDonation Boolean @default(true)
  includesLivingWill Boolean @default(false)
  
  specialInstructions String? @db.Text
  commonMistakes      String? @db.Text
  
  lastUpdated     DateTime
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([state])
}

model StatutoryPOAForm {
  id              String   @id @default(uuid())
  state           String
  
  formName        String
  citation        String
  effectiveDate   DateTime
  supersededDate  DateTime?
  isCurrentVersion Boolean @default(true)
  
  blankFormPath   String?
  fillableForm    Boolean  @default(false)
  formInstructions String? @db.Text
  
  powerCount      Int
  powers          Json
  
  hasAllOption    Boolean  @default(true)
  allOptionLabel  String?
  
  hasGiftsRider   Boolean  @default(false)
  giftsRiderPath  String?
  
  requiresAgentSig          Boolean @default(false)
  requiresSeparateAgentDoc  Boolean @default(false)
  
  hasMonitors     Boolean  @default(false)
  hasCoAgents     Boolean  @default(false)
  
  principalNotice String   @db.Text
  agentNotice     String   @db.Text
  
  witnessesRequired         String
  witnessRestrictions       String?  @db.Text
  notaryRequired            Boolean  @default(true)
  notaryBlockTemplate       String   @db.Text
  
  userGuidance    String?  @db.Text
  commonMistakes  String?  @db.Text
  
  uploadedById    String?
  uploadedBy      User?    @relation("UploadedStatutoryForms", fields: [uploadedById], references: [id], onDelete: SetNull)
  
  usageCount      Int      @default(0)
  lastUsedAt      DateTime?
  
  powerOfAttorneys PowerOfAttorney[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([state, effectiveDate])
  @@index([state, isCurrentVersion])
}

model StateSpecialRequirement {
  id              String @id @default(uuid())
  state           String
  requirementType String
  
  title           String
  description     String @db.Text
  citation        String?
  
  appliesTo       Json
  
  isMandatory     Boolean
  severity        String
  
  userGuidance    String @db.Text
  complianceSteps Json
  
  rejectionRisk   String?
  rejectedBy      Json?
  
  effectiveDate   DateTime
  supersededDate  DateTime?
  isActive        Boolean @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([state, requirementType, isActive])
}

// Endurawill - Production-Ready Database Schema
// Built for scale, audit trails, and granular permissions
// Version: 2.1 - Added Account Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

// Account Management Enums
enum PaymentFrequency {
  NONE
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
  ONE_TIME
  OTHER
}

enum PaymentStatus {
  UPCOMING
  PAID
  PAST_DUE
  PARTIAL
}

enum CalculationMode {
  AUTOMATIC
  MANUAL
}

// Asset & Liability Tax Tracking Enums
enum AcquisitionMethod {
  PURCHASE
  GIFT
  INHERITANCE
  CREATION        // For IP, businesses created
  EXCHANGE        // 1031 exchange
  CONVERSION      // Conversion of property type
  OTHER
}

enum BasisAdjustmentType {
  IMPROVEMENT     // Capital improvements
  DEPRECIATION    // Depreciation deductions
  CASUALTY_LOSS   // Casualty/theft loss
  EASEMENT        // Grant of easement
  SUBDIVISION     // Subdivision of property
  WASH_SALE       // Wash sale adjustments
  STOCK_SPLIT     // Stock splits
  OTHER
}

enum HoldingPeriod {
  SHORT_TERM      // ≤1 year
  LONG_TERM       // >1 year
  INHERITED       // Special rules for inherited assets
  UNKNOWN
}

enum ProbateStatus {
  PROBATE         // Subject to probate
  NON_PROBATE     // Passes outside probate (TOD, JTWROS, etc)
  TRUST_ASSET     // Held in trust
  EXEMPT          // Exempt from probate (small estate)
  UNKNOWN
}

enum ValueSourceType {
  APPRAISAL       // Professional appraisal
  MARKET_DATA     // Comparable sales, stock quotes
  STATEMENT       // Account statement
  COST_BASIS      // Original purchase price
  ESTIMATE        // Owner estimate
  TAX_ASSESSMENT  // Property tax assessment
  PLAID_API       // Auto-imported from Plaid
  OTHER
}

// ============================================
// TENANT = An Estate (Individual or Joint)
// ============================================
model Tenant {
  id          String   @id @default(uuid())
  name        String?
  type        String   @default("individual")
  
  maxOwners   Int      @default(1)
  ownerCount  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users             User[]
  documents         Document[]
  assets            Asset[]
  liabilities       Liability[]
  beneficiaries     Beneficiary[]
  directives        Directive[]
  finalArrangements FinalArrangement[]
  delegates         Delegate[]
  settings          TenantSettings?
  auditLogs         AuditLog[]
  accounts          Account[]
  paymentHistory    PaymentHistory[]
  powerOfAttorneys  PowerOfAttorney[]
  healthcarePOAs    HealthcarePOA[] @relation("HealthcarePOAs")
  poaRevocations    POARevocation[]
  wizardProgress    WizardProgress[]
  basisAdjustments  BasisAdjustment[]
  valueHistory      ValueHistory[]
  assetBeneficiaries AssetBeneficiary[]
  
  @@index([type])
}

// ============================================
// USER = A person with access to the estate
// ============================================
model User {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clerkId    String
  
  role       String
  isPrimary  Boolean  @default(false)
  
  fullName   String
  email      String?
  dob        DateTime?
  phone      String?
  
  profile    Profile?
  
  twoFactorEnabled Boolean @default(false)
  
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sessions              Session[]
  auditLogs             AuditLog[]
  createdDocuments      Document[] @relation("CreatedBy")
  modifiedDocuments     Document[] @relation("ModifiedBy")
  comments              Comment[]
  resourcePermissions   ResourcePermission[]
  delegateRecord        Delegate? @relation("DelegateUser")
  invitedDelegates      Delegate[] @relation("InvitedBy")
  createdAccounts       Account[] @relation("AccountCreatedBy")
  modifiedAccounts      Account[] @relation("AccountModifiedBy")
  principalPOAs         PowerOfAttorney[] @relation("PrincipalPOAs")
  agentPOAs             POAAgent[] @relation("UserPOAAgents")
  createdPOAs           PowerOfAttorney[] @relation("CreatedPOAs")
  revokedPOAs           POARevocation[] @relation("UserPOARevocations")
  poaAuditLogs          POAAuditLog[] @relation("UserPOAAuditLogs")
  principalHealthcarePOAs HealthcarePOA[] @relation("PrincipalHealthcarePOAs")
  createdHealthcarePOAs HealthcarePOA[] @relation("CreatedHealthcarePOAs")
  healthcarePOAAuditLogs HealthcarePOAAuditLog[] @relation("UserHealthcarePOAAuditLogs")
  uploadedNotaryTemplates NotaryBlockTemplate[] @relation("UploadedNotaryTemplates")
  wizardProgress        WizardProgress[]
  
  @@unique([tenantId, clerkId])
  @@index([clerkId])
  @@index([tenantId])
  @@index([role])
}

// ============================================
// PROFILE = Extended info for estate owners
// ============================================
model Profile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  stateResidence  String?
  maritalStatus   String?
  
  goals           Json?
  complexityLevel String?
  selectedPlan    String?
  
  hasCompletedOnboarding Boolean @default(false)
  onboardingStep  Int     @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  children        Child[]
  pets            Pet[]
}

// ============================================
// CHILD = Profile's children
// ============================================
model Child {
  id           String   @id @default(uuid())
  profileId    String
  profile      Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  fullName     String
  dob          DateTime?
  relationship String   @default("child")
  isMinor      Boolean  @default(true)
  
  guardianPreference String?
  beneficiaryId String?
  notes        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([profileId])
}

// ============================================
// PET = Profile's pets
// ============================================
model Pet {
  id             String   @id @default(uuid())
  profileId      String
  profile        Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  name           String
  type           String
  breed          String?
  age            Int?
  
  specialNeeds   String?
  vetInfo        Json?
  careInstructions String?
  
  caretakerPreference String?
  trustFund       Boolean @default(false)
  trustAmount     Decimal? @db.Decimal(15, 2)
  
  notes          String?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([profileId])
}

// ============================================
// RESOURCE PERMISSION = Granular access control
// ============================================
model ResourcePermission {
  id           String   @id @default(uuid())
  tenantId     String
  
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  resourceType String
  resourceId   String?
  documentType String?
  
  canView      Boolean  @default(false)
  canEdit      Boolean  @default(false)
  canDelete    Boolean  @default(false)
  canDownload  Boolean  @default(false)
  canShare     Boolean  @default(false)
  canModifyPermissions Boolean @default(false)
  
  grantedBy    String
  grantedAt    DateTime @default(now())
  revokedBy    String?
  revokedAt    DateTime?
  isActive     Boolean  @default(true)
  
  reason       String?
  notes        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([userId, resourceType, resourceId, documentType])
  @@index([userId])
  @@index([tenantId])
  @@index([resourceType, resourceId])
  @@index([isActive])
  @@index([documentType])
}

// ============================================
// TENANT SETTINGS = Estate-wide preferences
// ============================================
model TenantSettings {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  requireBothOwnersApproval Boolean @default(false)
  primaryCanOverride        Boolean @default(true)
  
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)
  notifyOnDelegateAccess Boolean @default(true)
  
  require2FA         Boolean @default(false)
  sessionTimeout     Int     @default(30)
  ipWhitelist        Json?
  
  autoVersioning     Boolean @default(true)
  retentionPeriod    Int     @default(50)
  
  allowDelegateInvite Boolean @default(true)
  requireDelegateApproval Boolean @default(true)
  maxDelegates       Int     @default(10)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// DOCUMENTS = Wills, Trusts, Directives
// ============================================
model Document {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  isFolder     Boolean  @default(false)
  parentId     String?
  parent       Document? @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children     Document[] @relation("FolderHierarchy")
  
  type      String
  title     String
  description String? @db.Text
  content   Json?
  
  fileUrl   String?
  fileName  String?
  fileType  String?
  fileSize  Int?
  
  version   Int      @default(1)
  status    String   @default("draft")
  
  signedAt  DateTime?
  signedBy  Json?
  witnessedBy Json?
  
  createdById  String?
  createdBy    User?   @relation("CreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  modifiedById String?
  modifiedBy   User?   @relation("ModifiedBy", fields: [modifiedById], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  accessLogs DocumentAccess[]
  comments   Comment[]
  
  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([createdById])
  @@index([parentId])
  @@index([isFolder])
}

// ============================================
// COMMENTS = Document comments
// ============================================
model Comment {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content    String   @db.Text
  
  parentCommentId String?
  parentComment   Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  
  isEdited   Boolean  @default(false)
  editedAt   DateTime?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([documentId])
  @@index([userId])
  @@index([parentCommentId])
}

// ============================================
// ASSETS = Property, accounts, valuables
// ============================================
model Asset {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Basic Info
  type        String   // real_estate, stocks, bonds, bank_account, vehicle, etc.
  description String
  category    String?  // For grouping: investment, personal, business
  
  // Current Valuation
  estimatedValue Decimal? @db.Decimal(15, 2)
  currency       String   @default("USD")
  valuationDate  DateTime?
  
  // Identification
  accountNumber  String?
  institution    String?
  location       String?  // Physical location or address
  serialNumber   String?  // VIN, serial number, parcel ID
  
  // Ownership Structure
  ownershipType  String   @default("sole")  // sole, joint, community, tenancy_in_common
  ownedBy        Json?    // Array of {userId, percentage} for partial ownership
  ownershipPct   Json?    // Deprecated - use ownedBy
  
  // Beneficiary Designation (for non-probate assets)
  hasBeneficiary Boolean  @default(false)
  beneficiaryInfo Json?   // Deprecated - use AssetBeneficiary model
  
  // === TAX BASIS TRACKING ===
  
  // Acquisition Details
  acquisitionDate     DateTime?
  acquisitionMethod   AcquisitionMethod?
  
  // Cost Basis (IRC §1012, §1014, §1015)
  originalCostBasis   Decimal? @db.Decimal(15, 2)  // Initial basis
  adjustedBasis       Decimal? @db.Decimal(15, 2)  // Current basis after adjustments
  
  // Fair Market Values
  fairMarketValueAtAcquisition Decimal? @db.Decimal(15, 2)  // For gifts under §1015
  fairMarketValueAtDeath       Decimal? @db.Decimal(15, 2)  // For step-up under §1014
  
  // Inheritance Tracking
  dateOfDeath         DateTime?  // Date of decedent's death for inherited assets
  carryoverBasis      Boolean?   // True for gifts, false for inherited (stepped-up)
  
  // Holding Period (affects capital gains rate)
  holdingPeriod       HoldingPeriod?
  
  // Complex Basis Scenarios
  taxLotInfo          Json?  // For stocks: [{purchaseDate, shares, costPerShare, totalCost}]
  basisNotes          String? @db.Text  // References to IRS Pub 551, court cases, etc.
  
  // Estate Planning
  probateStatus       ProbateStatus?
  includedInEstate    Boolean @default(true)  // Include in estate value calculation
  
  // Review & Compliance
  annualReviewReminder DateTime?  // Next review date
  lastReviewedAt       DateTime?
  reviewedBy           String?    // userId of who reviewed
  
  // Documentation
  notes          String? @db.Text
  attachments    Json?  // URLs to deeds, statements, appraisals
  dispositionInstructions String? @db.Text
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  basisAdjustments  BasisAdjustment[]  // History of basis changes
  valueHistory      ValueHistory[]     // Time-series valuations
  assetBeneficiaries AssetBeneficiary[] // Beneficiary allocations
  
  @@index([tenantId])
  @@index([type])
  @@index([category])
  @@index([probateStatus])
  @@index([acquisitionDate])
  @@index([annualReviewReminder])
}

// ============================================
// LIABILITIES = Debts, mortgages, loans
// ============================================
model Liability {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Basic Info
  type        String   // mortgage, auto_loan, credit_card, student_loan, personal_loan, etc.
  description String
  creditor    String?
  category    String?  // secured, unsecured, tax_debt, etc.
  
  // Amount Details
  originalAmount    Decimal  @db.Decimal(15, 2)  // Original loan amount
  currentBalance    Decimal  @db.Decimal(15, 2)  // Current balance
  currency          String   @default("USD")
  
  // Account Info
  accountNumber String?
  loanNumber    String?
  
  // Terms
  interestRate     Decimal? @db.Decimal(5, 2)   // Annual percentage rate
  originationDate  DateTime?
  maturityDate     DateTime?
  
  // Payment Info
  paymentSchedule String?   // monthly, quarterly, etc.
  monthlyPayment  Decimal? @db.Decimal(15, 2)
  nextPaymentDate DateTime?
  
  // Collateral (if secured)
  isSecured       Boolean  @default(false)
  collateralAssetId String?  // Link to Asset if applicable
  collateralDescription String?
  
  // Estate Planning
  probateStatus   ProbateStatus?  // How this debt is handled in probate
  
  // Tax Deductibility
  isDeductible    Boolean? // Is interest tax-deductible?
  taxCategory     String?  // mortgage_interest, student_loan_interest, etc.
  
  // Review
  annualReviewReminder DateTime?
  lastReviewedAt       DateTime?
  
  // Backwards compatibility
  amount      Decimal  @db.Decimal(15, 2)  // Deprecated - use currentBalance
  
  notes       String? @db.Text
  attachments Json?   // Loan documents, statements
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  valueHistory      ValueHistory[]  // Track balance over time
  
  @@index([tenantId])
  @@index([type])
  @@index([category])
  @@index([maturityDate])
  @@index([nextPaymentDate])
  @@index([annualReviewReminder])
}

// ============================================
// BENEFICIARIES = Who inherits what
// ============================================
model Beneficiary {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  fullName    String
  relationship String
  email       String?
  phone       String?
  address     Json?
  
  isPrimary   Boolean  @default(true)
  isCharity   Boolean  @default(false)
  charityTaxId String?
  
  shareType   String   @default("percentage")
  shareValue  Decimal? @db.Decimal(15, 2)
  sharePercent Decimal? @db.Decimal(5, 2)
  
  conditions  String?
  trusteeInfo Json?
  
  notes       String?
  
  // Relations
  assetAllocations  AssetBeneficiary[]  // Specific asset allocations
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([tenantId])
  @@index([relationship])
}

// ============================================
// ASSET BENEFICIARY ALLOCATION
// ============================================
model AssetBeneficiary {
  id              String   @id @default(uuid())
  assetId         String
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  beneficiaryId   String
  beneficiary     Beneficiary @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  
  // Allocation
  allocationType  String   @default("percentage")  // percentage, specific_amount, residuary
  percentage      Decimal? @db.Decimal(5, 2)      // 0.00 to 100.00
  specificAmount  Decimal? @db.Decimal(15, 2)     // Fixed dollar amount
  
  // Tax Planning
  taxAllocation   String?  // How taxes should be allocated: "proportional", "from_residue", "beneficiary_pays"
  taxNotes        String?  @db.Text
  
  // Conditions
  conditions      String?  @db.Text  // Conditions for receiving (age, marriage, etc.)
  isPrimary       Boolean  @default(true)
  isContingent    Boolean  @default(false)
  
  // Order of distribution
  priority        Int      @default(1)  // 1 = primary, 2 = first contingent, etc.
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([assetId])
  @@index([beneficiaryId])
  @@index([isPrimary])
  @@unique([assetId, beneficiaryId, priority])
}

// ============================================
// BASIS ADJUSTMENT TRACKING (Tax Compliance)
// ============================================
model BasisAdjustment {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  assetId         String
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  adjustmentDate  DateTime
  adjustmentType  BasisAdjustmentType
  amount          Decimal  @db.Decimal(15, 2)  // Positive or negative
  
  basisBefore     Decimal  @db.Decimal(15, 2)  // Basis before adjustment
  basisAfter      Decimal  @db.Decimal(15, 2)  // Basis after adjustment
  
  reason          String   @db.Text  // Detailed explanation
  documentation   String?  // URL to receipt, invoice, contractor bill, etc.
  
  // IRS Compliance
  taxYear         Int?     // Tax year this applies to
  formReference   String?  // e.g., "Form 4797", "Schedule D"
  irsPublication  String?  // e.g., "Pub 551", "Pub 523"
  
  // Audit Trail (immutable)
  createdBy       String   // userId
  createdAt       DateTime @default(now())
  
  // No updatedAt - these records are immutable for compliance
  
  @@index([tenantId])
  @@index([assetId])
  @@index([adjustmentDate])
  @@index([adjustmentType])
  @@index([taxYear])
}

// ============================================
// VALUE HISTORY (Time-Series Tracking)
// ============================================
model ValueHistory {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  assetId         String?
  asset           Asset?   @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  liabilityId     String?
  liability       Liability? @relation(fields: [liabilityId], references: [id], onDelete: Cascade)
  
  valueDate       DateTime
  amount          Decimal  @db.Decimal(15, 2)
  currency        String   @default("USD")
  
  source          ValueSourceType
  sourceDetails   String?  // Name of appraiser, statement date, etc.
  
  appraisalDoc    String?  // URL to appraisal document
  notes           String?  @db.Text
  
  // Audit
  recordedBy      String?  // userId who entered this value
  recordedAt      DateTime @default(now())
  
  @@index([tenantId])
  @@index([assetId])
  @@index([liabilityId])
  @@index([valueDate])
  @@index([source])
}

// ============================================
// DELEGATE = Someone with access to estate
// ============================================
model Delegate {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  invitedByUserId String
  invitedBy       User    @relation("InvitedBy", fields: [invitedByUserId], references: [id], onDelete: Restrict)
  
  fullName    String
  email       String
  phone       String?
  relationship String
  
  hasAccount      Boolean  @default(false)
  userId          String?  @unique
  user            User?    @relation("DelegateUser", fields: [userId], references: [id], onDelete: SetNull)
  
  status          String   @default("invited")
  isApproved      Boolean  @default(false)
  approvedBy      String?
  approvedAt      DateTime?
  
  invitationToken  String?  @unique
  invitedAt        DateTime @default(now())
  lastInviteSentAt DateTime?
  acceptedAt       DateTime?
  expiresAt        DateTime?
  revokedAt        DateTime?
  revokedBy        String?
  
  canAccessWhen   String   @default("after_death")
  customTrigger   String?
  
  documentPermissions    Json? @default("{ \"default\": { \"view\": false, \"edit\": false, \"delete\": false, \"download\": false, \"share\": false }, \"overrides\": {} }")
  assetPermissions       Json? @default("{ \"default\": { \"view\": false, \"edit\": false, \"delete\": false, \"download\": false, \"share\": false }, \"overrides\": {} }")
  liabilityPermissions   Json? @default("{ \"default\": { \"view\": false, \"edit\": false, \"delete\": false, \"download\": false, \"share\": false }, \"overrides\": {} }")
  beneficiaryPermissions Json? @default("{ \"view\": false, \"edit\": false, \"delete\": false }")
  settingsPermissions    Json? @default("{ \"view\": false, \"edit\": false }")
  profilePermissions     Json? @default("{ \"view\": false, \"edit\": false }")
  
  hasAnyPermissions Boolean @default(false)
  
  poaPermissions  Json?
  poaStartDate    DateTime?
  poaEndDate      DateTime?
  
  lastAccessedAt  DateTime?
  accessCount     Int      @default(0)
  lastNotifiedAt  DateTime?
  
  notes           String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  auditLogs AuditLog[]
  
  @@index([tenantId])
  @@index([email])
  @@index([status])
  @@index([hasAccount])
  @@index([invitedByUserId])
}

// ============================================
// DIRECTIVES = Healthcare, POA
// ============================================
model Directive {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type      String
  content   Json
  status    String   @default("draft")
  
  primaryAgent    Json?
  alternateAgent  Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([tenantId])
  @@index([type])
}

// ============================================
// FINAL ARRANGEMENTS = Funeral preferences
// ============================================
model FinalArrangement {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  preference String
  details    Json
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// AUDIT LOG = Track everything
// ============================================
model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  delegateId String?
  delegate  Delegate? @relation(fields: [delegateId], references: [id], onDelete: SetNull)
  actorType String
  actorName String
  
  action    String
  category  String
  
  resourceType String?
  resourceId   String?
  
  details      Json?
  result       String  @default("success")
  errorMessage String?
  
  sessionId String?
  ipAddress String?
  userAgent String?
  location  String?
  
  timestamp DateTime @default(now())
  
  @@index([tenantId])
  @@index([userId])
  @@index([delegateId])
  @@index([action])
  @@index([timestamp])
  @@index([category])
  @@index([resourceType])
}

// ============================================
// SESSION = Active login sessions
// ============================================
model Session {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clerkSessionId String   @unique
  
  ipAddress   String
  userAgent   String
  browser     String?
  os          String?
  device      String?
  location    String?
  
  loginAt        DateTime @default(now())
  lastActivityAt DateTime @default(now())
  logoutAt       DateTime?
  expiresAt      DateTime
  
  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([isActive])
  @@index([clerkSessionId])
}

// ============================================
// DOCUMENT ACCESS = Track who views what
// ============================================
model DocumentAccess {
  id           String   @id @default(uuid())
  documentId   String
  document     Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  accessorId   String
  accessorType String
  accessorName String
  
  action       String
  
  timestamp    DateTime @default(now())
  ipAddress    String?
  duration     Int?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([documentId])
  @@index([accessorId])
  @@index([timestamp])
  @@index([action])
}

// ============================================
// ACCOUNT MANAGEMENT SYSTEM
// ============================================

model Account {
  id                  String            @id @default(uuid())
  tenantId            String
  tenant              Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  category            String
  subcategory         String?
  
  accountName         String
  companyName         String
  companyAddress      String?
  companyPhone        String?
  companyWebsite      String?
  accountNumber       String?
  
  loginUsername       String?
  loginPassword       String?
  
  paymentFrequency    PaymentFrequency  @default(MONTHLY)
  customSchedule      Json?
  anticipatedAmount   Decimal?          @db.Decimal(10, 2)
  nextPaymentDate     DateTime?
  
  calculationMode     CalculationMode?  @default(MANUAL)
  balanceRemaining    Decimal?          @db.Decimal(12, 2)
  
  notes               String?           @db.Text
  isActive            Boolean           @default(true)
  status              String            @default("ACTIVE")
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  createdById         String?
  modifiedById        String?
  
  paymentHistory      PaymentHistory[]
  financialDetails    FinancialAccountDetails?
  loanDetails         LoanAccountDetails?
  vehicleDetails      VehicleAccountDetails?
  insuranceDetails    InsuranceAccountDetails?
  propertyDetails     PropertyAccountDetails?
  createdBy           User?             @relation("AccountCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  modifiedBy          User?             @relation("AccountModifiedBy", fields: [modifiedById], references: [id], onDelete: SetNull)
  
  @@index([tenantId, category])
  @@index([tenantId, nextPaymentDate])
  @@index([tenantId, isActive])
  @@index([createdById])
  @@index([modifiedById])
}

model PaymentHistory {
  id                String        @id @default(uuid())
  accountId         String
  account           Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  tenantId          String
  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Scheduled Payment
  dueDate           DateTime      // Original due date (keep for backward compatibility)
  scheduledDate     DateTime?     // Alias/new field for clarity
  scheduledAmount   Decimal       @db.Decimal(10, 2)
  
  // Manual Override for Due Date
  manualDueDate     DateTime?     // User changed due date for this payment
  originalDueDate   DateTime?     // Keep original for reference
  
  // Actual Payment
  paidDate          DateTime?     // Keep for backward compatibility
  actualDate        DateTime?     // Alias/new field for clarity
  paidAmount        Decimal?      @db.Decimal(10, 2)
  actualAmount      Decimal?      @db.Decimal(10, 2)
  
  // Payment Status
  status            PaymentStatus @default(UPCOMING)
  
  // Partial Payments
  partialPayments   Json?         // Array of partial payment records
  remainingBalance  Decimal?      @db.Decimal(10, 2)
  
  // Payment Method
  paymentMethod     String?       // "Checking", "Credit Card", "Cash", "Auto-Pay"
  paidFromAccountId String?       // Reference to Asset account (future)
  
  // Amortization (for loans)
  balanceAfter      Decimal?      @db.Decimal(12, 2)
  principalPaid     Decimal?      @db.Decimal(10, 2)
  interestPaid      Decimal?      @db.Decimal(10, 2)
  
  // Past Due Payoff Plan
  payoffPlan        Json?         // Structured payoff plan if past due
  
  notes             String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([accountId, dueDate])
  @@index([tenantId, status])
  @@index([tenantId, dueDate])
}

model FinancialAccountDetails {
  id                String   @id @default(uuid())
  accountId         String   @unique
  account           Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  accountNumber     String?
  routingNumber     String?
  
  institutionType   String?
  accountType       String?
  currentBalance    Decimal? @db.Decimal(12, 2)
  interestRate      Decimal? @db.Decimal(5, 2)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model LoanAccountDetails {
  id                String   @id @default(uuid())
  accountId         String   @unique
  account           Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  accountNumber     String?
  
  principalAmount   Decimal? @db.Decimal(12, 2)
  currentBalance    Decimal? @db.Decimal(12, 2)
  interestRate      Decimal? @db.Decimal(5, 2)
  loanTerm          Int?
  maturityDate      DateTime?
  minimumPayment    Decimal? @db.Decimal(10, 2)
  
  loanType          String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model VehicleAccountDetails {
  id                  String   @id @default(uuid())
  accountId           String   @unique
  account             Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  vin                 String?
  make                String?
  model               String?
  year                Int?
  licensePlate        String?
  
  loanAmount          Decimal? @db.Decimal(12, 2)
  registrationExpires DateTime?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model InsuranceAccountDetails {
  id                String   @id @default(uuid())
  accountId         String   @unique
  account           Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  policyNumber      String?
  policyType        String?
  coverageAmount    Decimal? @db.Decimal(12, 2)
  deductible        Decimal? @db.Decimal(10, 2)
  
  policyStart       DateTime?
  policyEnd         DateTime?
  
  beneficiaries     String?  @db.Text
  agentName         String?
  agentContact      String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model PropertyAccountDetails {
  id                String   @id @default(uuid())
  accountId         String   @unique
  account           Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  propertyAddress   String?
  unitNumber        String?
  propertyType      String?
  
  loanAmount        Decimal? @db.Decimal(12, 2)
  interestRate      Decimal? @db.Decimal(5, 2)
  leaseEndDate      DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================
// POWER OF ATTORNEY SYSTEM
// ============================================

enum POAType {
  DURABLE
  GENERAL
  LIMITED
  SPRINGING
  HEALTHCARE
}

enum POAStatus {
  DRAFT
  ACTIVE
  REVOKED
  EXPIRED
  DORMANT
  ACTIVATION_PENDING
  RECOVERED
}

model PowerOfAttorney {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  principalUserId String?
  principalUser   User?    @relation("PrincipalPOAs", fields: [principalUserId], references: [id], onDelete: SetNull)
  principalName   String
  principalAddress String
  principalCity   String
  principalState  String
  principalZip    String
  principalDOB    DateTime?
  principalSSN    String?  @db.Text
  principalPhone  String?
  principalEmail  String?
  
  poaType         POAType
  isDurable       Boolean  @default(true)
  isLimited       Boolean  @default(false)
  isSpringing     Boolean  @default(false)
  
  effectiveDate   DateTime?
  effectiveImmediately Boolean @default(true)
  expirationDate  DateTime?
  
  springingStatus         String?
  springingCondition      String?  @db.Text
  requiresPhysicianCert   Boolean  @default(false)
  numberOfPhysiciansReq   Int      @default(1)
  physicianCertifications PhysicianCertification[]
  activatedAt             DateTime?
  activationNotifiedTo    Json?
  recoveryCertification   String?
  recoveredAt             DateTime?
  physicianCertCost       Decimal? @db.Decimal(10, 2)
  
  status          POAStatus @default(DRAFT)
  
  grantedPowers   POAGrantedPower[]
  excludedPowers  Json?
  limitations     String?  @db.Text
  specialInstructions String? @db.Text
  
  intendedUse     String   @default("general")
  willBeRecorded  Boolean  @default(false)
  
  agentCompensation       Boolean  @default(false)
  compensationDetails     String?  @db.Text
  requireDualSignatures   Boolean  @default(false)
  dualSignatureThreshold  Decimal? @db.Decimal(12, 2)
  requireAnnualAccounting Boolean  @default(false)
  
  hasCoAgents             Boolean  @default(false)
  coAgentsMustActJointly  Boolean  @default(false)
  
  notaryBlockType String?
  notaryState     String?
  notaryCounty    String?
  notarizedAt     DateTime?
  notaryName      String?
  notaryCommission String?
  notaryExpiration DateTime?
  onlineNotarization Boolean @default(false)
  
  requiresWitnesses       Boolean  @default(false)
  numberOfWitnesses       Int?
  witnesses               POAWitness[]
  
  state                   String
  usesStatutoryForm       Boolean  @default(false)
  statutoryFormId         String?
  statutoryForm           StatutoryPOAForm? @relation(fields: [statutoryFormId], references: [id])
  
  generatedDocument String?
  signedDocument    String?
  documentTemplateUsed String?
  
  recordedAt        DateTime?
  recordingCounty   String?
  recordingBookPage String?
  
  agents            POAAgent[]
  revocations       POARevocation[]
  auditLogs         POAAuditLog[]
  powerLimitations  POAPowerLimitation[]
  
  createdById     String?
  createdBy       User?    @relation("CreatedPOAs", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([principalUserId])
  @@index([status])
  @@index([state])
  @@index([poaType])
}

model POAAgent {
  id              String @id @default(uuid())
  poaId           String
  poa             PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  agentType       String
  order           Int
  
  userId          String?
  user            User?   @relation("UserPOAAgents", fields: [userId], references: [id], onDelete: SetNull)
  fullName        String
  relationship    String?
  email           String?
  phone           String?
  address         String?
  city            String?
  state           String?
  zip             String?
  
  specificPowers  Json?
  
  hasAccepted     Boolean  @default(false)
  acceptedAt      DateTime?
  acceptanceDocument String?
  declinedAt      DateTime?
  declineReason   String?  @db.Text
  
  isCompensated   Boolean  @default(false)
  compensationDetails String? @db.Text
  
  requiresSignature       Boolean @default(false)
  requiresNotarization    Boolean @default(false)
  signedAt                DateTime?
  signatureDocument       String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([poaId])
  @@index([userId])
}

model POAWitness {
  id          String @id @default(uuid())
  poaId       String
  poa         PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  fullName    String
  address     String?
  city        String?
  state       String?
  zip         String?
  relationship String?
  
  signedAt    DateTime?
  signature   String?
  
  isAgent     Boolean @default(false)
  isSpouse    Boolean @default(false)
  isRelative  Boolean @default(false)
  isNotary    Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([poaId])
}

model POAPowerCategoryDefinition {
  id                    String @id @default(uuid())
  
  categoryNumber        Int
  categoryName          String
  categoryLetter        String?
  
  statutoryDefinition   String @db.Text
  plainLanguageDesc     String @db.Text
  
  isDangerous           Boolean @default(false)
  dangerWarningText     String? @db.Text
  
  examples              Json
  stateSpecificNotes    Json?
  
  subPowers             POASubPowerDefinition[]
  grantedPowers         POAGrantedPower[]
  
  effectiveDate         DateTime
  supersededDate        DateTime?
  isCurrentVersion      Boolean @default(true)
  
  sortOrder             Int
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@unique([categoryNumber, effectiveDate])
  @@index([categoryNumber, isCurrentVersion])
}

model POASubPowerDefinition {
  id          String   @id @default(uuid())
  categoryId  String
  category    POAPowerCategoryDefinition @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  powerText   String   @db.Text
  isDangerous Boolean  @default(false)
  citation    String?
  
  sortOrder   Int
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([categoryId])
}

model POAGrantedPower {
  id              String   @id @default(uuid())
  poaId           String
  poa             PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  categoryId      String
  category        POAPowerCategoryDefinition @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  grantedSubPowers Json
  grantAllSubPowers Boolean @default(false)
  
  principalInitials String?
  dateInitialed     DateTime?
  
  limitations     String?  @db.Text
  notes           String?  @db.Text
  
  powerLimitations POAPowerLimitation[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([poaId, categoryId])
  @@index([poaId])
  @@index([categoryId])
}

model POAPowerLimitation {
  id                String   @id @default(cuid())
  poaId             String
  grantedPowerId    String
  
  limitationType    String
  limitationText    String   @db.Text
  
  monetaryLimit     Decimal? @db.Decimal(15, 2)
  timeLimit         DateTime?
  geographicLimit   String?
  specificAsset     String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  poa               PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  grantedPower      POAGrantedPower @relation(fields: [grantedPowerId], references: [id], onDelete: Cascade)
  
  @@index([poaId])
  @@index([grantedPowerId])
  @@index([limitationType])
}

model LimitedPOATemplate {
  id                      String   @id @default(cuid())
  
  name                    String
  description             String   @db.Text
  
  requiredPowerCategories String[]
  defaultLimitations      Json
  
  commonUseCase           String   @db.Text
  
  isActive                Boolean  @default(true)
  sortOrder               Int      @default(0)
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  @@index([isActive])
  @@index([sortOrder])
}

model PhysicianCertification {
  id              String   @id @default(uuid())
  poaId           String
  poa             PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  certificationNumber Int @default(1)
  
  physicianName   String
  licenseNumber   String
  licenseState    String
  specialty       String?
  address         String
  phone           String
  email           String?
  
  examinationDate DateTime
  examinationLocation String?
  principalName   String
  
  certificationText String @db.Text
  findings        String   @db.Text
  
  isIncapacitated Boolean  @default(true)
  impairmentType  String?
  diagnosis       String?  @db.Text
  functionalFindings Json?
  
  isPermanent     Boolean?
  isTemporary     Boolean?
  expectedRecoveryDate DateTime?
  
  testConducted   Json?
  
  notarizedAt     DateTime?
  notaryName      String?
  notaryState     String?
  
  uploadedDocument String?
  
  acceptedAt      DateTime?
  acceptedById    String?
  rejectedAt      DateTime?
  rejectedById    String?
  rejectionReason String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([poaId])
}

model POARevocation {
  id              String   @id @default(uuid())
  poaId           String
  poa             PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  revocationType  String
  
  principalName   String
  principalAddress String
  
  revokedAt       DateTime
  revokedById     String?
  revokedBy       User?    @relation("UserPOARevocations", fields: [revokedById], references: [id], onDelete: SetNull)
  
  reason          String?  @db.Text
  affectedAgents  Json?
  
  notifiedParties Json?
  notificationsSent Boolean @default(false)
  
  recordedAt      DateTime?
  recordingCounty String?
  recordingBookPage String?
  
  revocationDocument String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([poaId])
  @@index([tenantId])
}

model POAAuditLog {
  id          String   @id @default(uuid())
  poaId       String
  poa         PowerOfAttorney @relation(fields: [poaId], references: [id], onDelete: Cascade)
  
  userId      String?
  user        User?    @relation("UserPOAAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  
  action      String
  category    String
  
  details     Json?
  
  ipAddress   String?
  userAgent   String?  @db.Text
  
  timestamp   DateTime @default(now())
  
  @@index([poaId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

model HealthcarePOA {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation("HealthcarePOAs", fields: [tenantId], references: [id], onDelete: Cascade)
  
  principalUserId String?
  principalUser   User?    @relation("PrincipalHealthcarePOAs", fields: [principalUserId], references: [id], onDelete: SetNull)
  principalName   String
  principalAddress String
  principalCity   String
  principalState  String
  principalZip    String
  principalDOB    DateTime?
  principalPhone  String?
  principalEmail  String?
  
  agentName       String
  agentRelationship String?
  agentPhone      String?
  agentEmail      String?
  agentAddress    String?
  
  alternateAgents Json?
  
  generalMedicalCare      Boolean @default(true)
  mentalHealthTreatment   Boolean @default(true)
  endOfLifeDecisions      Boolean @default(true)
  artificialNutrition     Boolean @default(true)
  artificialHydration     Boolean @default(true)
  painManagement          Boolean @default(true)
  organDonation           Boolean @default(false)
  organDonationDetails    String?  @db.Text
  autopsyConsent          Boolean @default(false)
  
  hasDNR          Boolean @default(false)
  dnrDocument     String?
  hasPOLST        Boolean @default(false)
  polstDocument   String?
  
  hipaaAuthorized Boolean @default(true)
  authorizedParties Json?
  
  religiousBeliefs      String? @db.Text
  culturalPreferences   String? @db.Text
  painManagementPrefs   String? @db.Text
  endOfLifePreferences  String? @db.Text
  specialInstructions   String? @db.Text
  
  status          POAStatus  @default(DRAFT)
  
  signedAt        DateTime?
  
  witnesses       HealthcarePOAWitness[]
  requiresWitnesses Boolean @default(true)
  numberOfWitnesses Int     @default(2)
  
  notarizedAt     DateTime?
  notaryState     String?
  notaryCounty    String?
  notaryName      String?
  requiresNotary  Boolean  @default(false)
  
  state           String
  statutoryFormUsed Boolean @default(true)
  formPDFLink     String?
  
  generatedDocument String?
  signedDocument    String?
  
  revokedAt       DateTime?
  revocationDocument String?
  
  auditLogs       HealthcarePOAAuditLog[]
  
  createdById     String?
  createdBy       User?    @relation("CreatedHealthcarePOAs", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([principalUserId])
  @@index([status])
}

model HealthcarePOAWitness {
  id              String @id @default(uuid())
  healthcarePOAId String
  healthcarePOA   HealthcarePOA @relation(fields: [healthcarePOAId], references: [id], onDelete: Cascade)
  
  fullName        String
  address         String?
  city            String?
  state           String?
  zip             String?
  relationship    String?
  
  signedAt        DateTime?
  signature       String?
  
  isAgent         Boolean @default(false)
  isHealthcareProvider Boolean @default(false)
  isFacilityOwner Boolean @default(false)
  isRelative      Boolean @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([healthcarePOAId])
}

model HealthcarePOAAuditLog {
  id              String @id @default(uuid())
  healthcarePOAId String
  healthcarePOA   HealthcarePOA @relation(fields: [healthcarePOAId], references: [id], onDelete: Cascade)
  
  userId          String?
  user            User?  @relation("UserHealthcarePOAAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  
  action          String
  category        String
  details         Json?
  
  timestamp       DateTime @default(now())
  
  @@index([healthcarePOAId])
  @@index([userId])
}

model StateRequirements {
  id          String @id @default(uuid())
  state       String @unique
  stateName String
  
  notarizationRequired      Boolean  @default(true)
  notarizationStronglyRec   Boolean  @default(false)
  
  witnessesRequired         Boolean  @default(false)
  numberOfWitnesses         Int?
  minimumWitnessAge         Int      @default(18)
  witnessesOrNotary         Boolean  @default(false)
  
  agentCannotBeWitness      Boolean  @default(true)
  notaryCannotBeWitness     Boolean  @default(false)
  spouseCannotBeWitness     Boolean  @default(false)
  relativesCannotBeWitness  Boolean  @default(false)
  witnessRestrictions       String?  @db.Text
  
  hasStatutoryForm          Boolean  @default(false)
  statutoryFormRequired     Boolean  @default(false)
  statutoryFormCitation     String?
  statutoryFormNotes        String?  @db.Text
  
  durabilityRequired        Boolean  @default(true)
  durabilityWording         String?  @db.Text
  defaultDurability         String   @default("durable")
  
  allowsSpringing           Boolean  @default(true)
  springingBannedReason     String?
  numberOfPhysiciansRequired Int     @default(1)
  courtDeterminationAllowed Boolean  @default(false)
  
  requiresAgentSignature    Boolean  @default(false)
  requiresAgentNotarization Boolean  @default(false)
  agentAcceptanceWording    String?  @db.Text
  
  requiredPrincipalNotice   String?  @db.Text
  requiredAgentNotice       String?  @db.Text
  
  recordingMandatoryFor     Json?
  recordingInstructions     String?  @db.Text
  estimatedRecordingFee     Decimal? @db.Decimal(6, 2)
  
  hotPowersRequireSeparateConsent Boolean @default(false)
  hotPowersList             Json?
  giftingAnnualLimit        Decimal? @db.Decimal(10, 2)
  
  specialNotes              String?  @db.Text
  strictnessLevel           String   @default("standard")
  
  allowsRemoteNotarization  Boolean  @default(true)
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  @@index([state])
}

model NotaryBlockTemplate {
  id              String @id @default(uuid())
  
  state           String
  documentType    String
  
  templateText    String @db.Text
  
  statutoryCitation String?
  effectiveDate     DateTime
  supersededDate    DateTime?
  isCurrentVersion  Boolean @default(true)
  
  requiresWitnesses Boolean @default(false)
  numberOfWitnesses Int?
  witnessRelationshipRules String? @db.Text
  requiresNotary    Boolean @default(true)
  notaryCanBeWitness Boolean @default(false)
  
  requiresMaritalStatus   Boolean @default(false)
  requiresCommissionNumber Boolean @default(false)
  requiresSeal            Boolean @default(true)
  allowsOnlineNotarization Boolean @default(false)
  
  specialInstructions     String? @db.Text
  commonRejectionReasons  String? @db.Text
  
  uploadedById    String?
  uploadedBy      User?   @relation("UploadedNotaryTemplates", fields: [uploadedById], references: [id], onDelete: SetNull)
  
  usageCount      Int     @default(0)
  lastUsedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([state, documentType, effectiveDate])
  @@index([state, documentType, isCurrentVersion])
}

model IncapacityDefinition {
  id              String   @id @default(uuid())
  state           String   @unique
  
  definitionType  String
  
  statutoryText   String   @db.Text
  plainLanguage   String   @db.Text
  
  isUPOAAState    Boolean  @default(false)
  includesMissing Boolean  @default(false)
  includesAbroad  Boolean  @default(false)
  
  requiresCognitiveTesting Boolean @default(false)
  requiresFunctionalAssess Boolean @default(false)
  requiresSpecificDiagnosis Boolean @default(false)
  
  physicianGuidance String? @db.Text
  exampleFindings   String? @db.Text
  
  specialNotes    String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([state])
}

model HealthcarePOAStateForm {
  id              String   @id @default(uuid())
  state           String   @unique
  stateName       String
  
  formName        String
  pdfLink         String
  spanishLink     String?
  
  requiresNotary  Boolean
  requiresWitnesses Boolean
  numberOfWitnesses Int?
  notaryOrWitnesses Boolean @default(false)
  
  witnessRestrictions String? @db.Text
  
  includesDNR     Boolean @default(false)
  includesPOLST   Boolean @default(false)
  includesOrganDonation Boolean @default(true)
  includesLivingWill Boolean @default(false)
  
  specialInstructions String? @db.Text
  commonMistakes      String? @db.Text
  
  lastUpdated     DateTime
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([state])
}

model StatutoryPOAForm {
  id              String   @id @default(uuid())
  state           String
  
  formName        String
  citation        String
  effectiveDate   DateTime
  supersededDate  DateTime?
  isCurrentVersion Boolean @default(true)
  
  blankFormPath   String?
  fillableForm    Boolean  @default(false)
  formInstructions String? @db.Text
  
  powerCount      Int
  powers          Json
  
  hasAllOption    Boolean  @default(true)
  allOptionLabel  String?
  
  hasGiftsRider   Boolean  @default(false)
  giftsRiderPath  String?
  
  requiresAgentSig          Boolean @default(false)
  requiresSeparateAgentDoc  Boolean @default(false)
  
  hasMonitors     Boolean  @default(false)
  hasCoAgents     Boolean  @default(false)
  
  principalNotice String   @db.Text
  agentNotice     String   @db.Text
  
  witnessesRequired         String
  witnessRestrictions       String?  @db.Text
  notaryRequired            Boolean  @default(true)
  notaryBlockTemplate       String   @db.Text
  
  userGuidance    String?  @db.Text
  commonMistakes  String?  @db.Text
  
  uploadedById    String?
  
  usageCount      Int      @default(0)
  lastUsedAt      DateTime?
  
  powerOfAttorneys PowerOfAttorney[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([state, effectiveDate])
  @@index([state, isCurrentVersion])
}

// ============================================
// WIZARD PROGRESS TRACKING
// ============================================

model WizardProgress {
  id                String  @id @default(uuid())
  
  tenantId          String
  tenant            Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  documentType      String
  sessionId         String  @unique
  
  currentSection    String
  currentStep       String
  completedSections Json
  completedSteps    Json
  
  formData          Json
  validationErrors  Json?
  
  estimatedCompletion Int?
  timeSpent         Int     @default(0)
  lastActivity      DateTime @default(now())
  
  isCompleted       Boolean @default(false)
  isAbandoned       Boolean @default(false)
  abandonedReason   String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([tenantId, userId, documentType])
  @@index([userId])
  @@index([sessionId])
  @@index([lastActivity])
}
